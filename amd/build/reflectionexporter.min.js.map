{"version":3,"sources":["../src/reflectionexporter.js"],"names":["define","$","Ajax","Log","PDFLib","Templates","Controls","data","CANDIDATE_PERSONAL_CODE","FIRST_REFLECTION_SESSION","FIRST_REFLECTION_SESSION_SUPERVISOR_INITIALS","INTERIM_REFLECTION","INTERIM_REFLECTION_SUPERVISOR_INITIALS","FINAL_REFLECTION","FINAL_REFLECTION_SUPERVISOR_INITIALS","SUPERVISOR_COMMENT","prototype","main","new","getreflectionsjson","getreflectionspdf","console","log","self","call","methodname","args","rid","done","response","users","JSON","parse","reflecjson","processReflections","pdfs","savePDFInDB","fail","reason","error","studentpdfs","i","length","fillformAndSave","pdf","student","uid","reflections","userid","courseid","cid","push","user","formUrl","fileurl","fetch","then","res","arrayBuffer","formPdfBytes","PDFDocument","load","pdfDoc","form","getForm","fields","getFields","forEach","field","setFormFields","saveAsBase64","fieldName","getName","Y","getTextField","setText","id","onlinetext","getDropdown","select","month","dp","si","pdfjson","stringify","context","savedrecords","coursename","showuseridentity","reflecid","firstuserid","render","html","js","document","querySelector","fadeOut","replaceNodeContents","fadeIn","bind","ex","init","control"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n *\n *\n * @package    report\n * @subpackage reflectionexporter\n * @copyright  2022 Veronica Bermegui\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    \"jquery\",\n    \"core/ajax\",\n    \"core/log\",\n    \"report_reflectionexporter/pdf-lib\",\n    \"core/templates\",\n\n], function ($, Ajax, Log, PDFLib, Templates) {\n    \"use strict\";\n\n    function init(data, coursename) {\n        var control = new Controls(data);\n        control.main();\n    }\n\n    function Controls(data) {\n        this.data = data;\n        this.CANDIDATE_PERSONAL_CODE = 'Text1';\n        this.FIRST_REFLECTION_SESSION = 'Text3';\n        this.FIRST_REFLECTION_SESSION_SUPERVISOR_INITIALS = 'Text5';\n        this.INTERIM_REFLECTION = 'Text6';\n        this.INTERIM_REFLECTION_SUPERVISOR_INITIALS = 'Text8';\n        this.FINAL_REFLECTION = 'Text9';\n        this.FINAL_REFLECTION_SUPERVISOR_INITIALS = 'Text11';\n        this.SUPERVISOR_COMMENT = 'Text12';\n    }\n\n    /**\n     * Run the controller.\n     *\n     */\n    Controls.prototype.main = function () {\n        // Get the reflections data.\n\n        if (this.data.new == 1) {\n            this.getreflectionsjson()\n\n        } else {\n            this.getreflectionspdf();\n        }\n\n    };\n\n    Controls.prototype.getreflectionspdf = function () {\n        console.log(\"Viene....\");\n    }\n    Controls.prototype.getreflectionsjson = async function () {\n        var self = this;\n\n        Ajax.call([{\n            methodname: \"report_reflectionexporter_get_reflections\",\n            args: {\n                rid: this.data.rid,\n            },\n            done: async function (response) {\n                const users = JSON.parse(response.reflecjson);\n                const pdfs = await self.processReflections(users);\n\n                self.savePDFInDB(pdfs);\n\n            },\n            fail: function (reason) {\n                Log.error(reason);\n            },\n        }, ]);\n    };\n\n    // Returns an array with the users PDF enconded in base64\n    Controls.prototype.processReflections = async function (users) {\n        const studentpdfs = [];\n        for (var i = 0; i < users.length; i++) {\n            const pdf = await this.fillformAndSave(users[i]);\n\n            const student = {\n                uid: users[i].reflections[0].userid,\n                courseid: this.data.cid,\n                rid: this.data.rid,\n                pdf: pdf\n            };\n\n            studentpdfs.push(student);\n\n        }\n\n        return studentpdfs;\n\n    };\n    // Fill PDF with data and return the generted file in base64\n    Controls.prototype.fillformAndSave = async function (user) {\n        const formUrl = this.data.fileurl;\n        const formPdfBytes = await fetch(formUrl).then((res) => res.arrayBuffer());\n        const pdfDoc = await PDFLib.PDFDocument.load(formPdfBytes);\n        const form = pdfDoc.getForm();\n        const fields = form.getFields();\n\n        fields.forEach((field) => {\n            this.setFormFields(user, form, field);\n        });\n\n        // Return the base64 PDF\n        return await pdfDoc.saveAsBase64();\n\n    };\n    /**\n     * Fields to complete for the student\n     *  Candidate personal code: Text1\n     * First reflection session: Text3\n     *  Month first page: Dropdown1\n     *  DP: Dropdown2\n     *  supervisor id: Text5\n     * Second reflection: Text6\n     *  Month second page: Dropdown3\n     *  DP: Dropdown4\n     *  supervisor id: Text8\n     *  third reflection: Text9\n     *  Month third page: Dropdown5\n     *  DP: Dropdown6\n     *  supervisor id: Text11\n     * \n     * @param {*} user \n     * @param {*} form \n     * @param {*} field \n     */\n    Controls.prototype.setFormFields = async function (user, form, field) {\n        var self = this;\n        const fieldName = field.getName();\n        switch (fieldName) {\n            case self.CANDIDATE_PERSONAL_CODE: //Candaite personal code \"Text1\"\n                Y.log(user);\n                form.getTextField(fieldName).setText(String(user.id));\n                break;\n            case self.FIRST_REFLECTION_SESSION: // First reflection session (1st page) \"Text3\"\n                form.getTextField(fieldName).setText(JSON.parse(user.reflections[0].onlinetext));\n                break;\n            case \"Dropdown1\": // Month\n                form.getDropdown(fieldName).select(user.reflections[0].month);\n                break;\n            case \"Dropdown2\": // DP\n                form.getDropdown(fieldName).select(String(user.dp)); // just to make sure that we are sending a string\n                break;\n            case self.FIRST_REFLECTION_SESSION_SUPERVISOR_INITIALS: // Supervisor initials \"Text5\"\n                form.getTextField(fieldName).setText(String(user.si));\n                break;\n            case self.INTERIM_REFLECTION: // Interim reflection (2nd page) \"Text6\"\n                form.getTextField(fieldName).setText(JSON.parse(user.reflections[1].onlinetext));\n                break;\n            case \"Dropdown3\": // Month\n                form.getDropdown(fieldName).select(user.reflections[1].month);\n                break;\n            case \"Dropdown4\": // DP\n                form.getDropdown(fieldName).select(String(user.dp));\n                break;\n            case self.INTERIM_REFLECTION_SUPERVISOR_INITIALS: // Supervisor initials \"Text8\"\n                form.getTextField(fieldName).setText(String(user.si));\n                break;\n            case self.FINAL_REFLECTION: // Final reflection (3rd page) \"Text9\"\n                form.getTextField(fieldName).setText(JSON.parse(user.reflections[2].onlinetext));\n                break;\n            case \"Dropdown5\": // Month\n                form.getDropdown(fieldName).select(user.reflections[2].month);\n                break;\n            case \"Dropdown6\": //DP //dp\n                form.getDropdown(fieldName).select(String(user.dp));\n                break;\n            case self.FINAL_REFLECTION_SUPERVISOR_INITIALS: // Supervisor initials \"Text11\"\n                form.getTextField(fieldName).setText(String(user.si));\n                break;\n        }\n    };\n\n    // Call WS to save pdf data in DB.\n    Controls.prototype.savePDFInDB = function (pdfs) {\n        var self = this;\n\n        const pdfjson = JSON.stringify(pdfs);\n        Ajax.call([{\n            methodname: \"report_reflectionexporter_save_pdfbase64\",\n            args: {\n                pdfs: pdfjson,\n            },\n            done: function (response) {\n                \n                const context = {\n                    pdfjson: response.savedrecords,\n                    courseid: self.data.cid,\n                    coursename: self.data.coursename,\n                    showuseridentity: true,\n                    reflecid: self.data.rid,\n                    firstuserid: 0,\n                }\n\n                Templates.render('report_reflectionexporter/viewer', context)\n                    .done(function (html, js) {\n                        $(document.querySelector('.importing-animation')).fadeOut(\"fast\", function () {\n                            Templates.replaceNodeContents($(document.querySelector('.importing-animation')), html, js);\n                            $(document.querySelector('.importing-animation')).fadeIn(\"fast\");\n                        }.bind(this));\n                    }).fail(function (ex) {\n                        console.log(ex);\n                    });\n\n            },\n            fail: function (reason) {\n                Log.error(reason);\n            },\n        }, ]);\n    }\n\n    return {\n        init: init,\n    };\n});"],"file":"reflectionexporter.min.js"}