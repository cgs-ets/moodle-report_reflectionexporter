{"version":3,"sources":["../src/viewer_panel.js"],"names":["define","$","Y","notification","templates","fragment","ajax","str","Event","ViewerPanel","selector","_regionSelector","_region","_userCache","console","log","registerEventListeners","prototype","_lastUserId","_lastAttemptNumber","nextUserId","nextUser","_niceReplaceNodeContents","node","html","js","promise","Deferred","fadeOut","replaceNodeContents","fadeIn","resolve","_saveFormState","checked","prop","val","_submitForm","event","form","find","show","trigger","notifyFormSubmitAjax","data","serialize","assignmentid","attr","call","methodname","args","userid","jsonformdata","JSON","stringify","done","_handleFormSubmissionResponse","bind","fail","exception","formdata","response","length","document","get_strings","key","component","strs","alert","use","M","core_formchangechecker","reset_form_dirty_state","hide","_resetForm","e","_refreshGradingPanel","_chooseAttempt","link","target","submissionsId","submissionsform","getElementById","formcopy","clone","formhtml","wrap","confirm","attemptnumber","_addPopoutButtons","region","render","parents","closest","addClass","parent","append","on","_togglePopout","preventDefault","container","hasClass","removeClass","window","util","js_pending","_getNextUser","_handleSaveAndShowNext","getPanelElement","collapsePanel","expandPanel","docElement"],"mappings":"AAyBAA,OAAM,0CAAC,CAAC,QAAD,CAAW,UAAX,CAAuB,mBAAvB,CAA4C,gBAA5C,CAA8D,eAA9D,CACC,WADD,CACc,UADd,EAC4B,YAD5B,CAAD,CAGF,SAAUC,CAAV,CAAaC,CAAb,CAAgBC,CAAhB,CAA8BC,CAA9B,CAAyCC,CAAzC,CAAmDC,CAAnD,CAAyDC,CAAzD,CAA8DC,CAA9D,CAAqE,CAQjE,GAAIC,CAAAA,CAAW,CAAG,SAAUC,CAAV,CAAoB,CAClC,KAAKC,eAAL,CAAuBD,CAAvB,CACA,KAAKE,OAAL,CAAeX,CAAC,CAACS,CAAD,CAAhB,CACA,KAAKG,UAAL,CAAkB,EAAlB,CACAC,OAAO,CAACC,GAAR,CAAY,IAAZ,EACA,KAAKC,sBAAL,EACH,CAND,CASAP,CAAW,CAACQ,SAAZ,CAAsBN,eAAtB,CAAwC,IAAxC,CAGAF,CAAW,CAACQ,SAAZ,CAAsBC,WAAtB,CAAoC,CAApC,CAGAT,CAAW,CAACQ,SAAZ,CAAsBE,kBAAtB,CAA2C,CAAC,CAA5C,CAGAV,CAAW,CAACQ,SAAZ,CAAsBL,OAAtB,CAAgC,IAAhC,CAGAH,CAAW,CAACQ,SAAZ,CAAsBG,UAAtB,CAAmC,IAAnC,CAGAX,CAAW,CAACQ,SAAZ,CAAsBI,QAAtB,IAYAZ,CAAW,CAACQ,SAAZ,CAAsBK,wBAAtB,CAAiD,SAAUC,CAAV,CAAgBC,CAAhB,CAAsBC,CAAtB,CAA0B,CACvE,GAAIC,CAAAA,CAAO,CAAGzB,CAAC,CAAC0B,QAAF,EAAd,CAEAJ,CAAI,CAACK,OAAL,CAAa,MAAb,CAAqB,UAAY,CAC7BxB,CAAS,CAACyB,mBAAV,CAA8BN,CAA9B,CAAoCC,CAApC,CAA0CC,CAA1C,EACAF,CAAI,CAACO,MAAL,CAAY,MAAZ,CAAoB,UAAY,CAC5BJ,CAAO,CAACK,OAAR,EACH,CAFD,CAGH,CALD,EAOA,MAAOL,CAAAA,CAAO,CAACA,OAAR,EACV,CAXD,CAkBAjB,CAAW,CAACQ,SAAZ,CAAsBe,cAAtB,CAAuC,UAAY,CAE/C,GAAIC,CAAAA,CAAO,CAAGhC,CAAC,CAAC,4EAAD,CAAD,CAA4EiC,IAA5E,CAAiF,SAAjF,CAAd,CACAjC,CAAC,CAAC,gDAAD,CAAD,CAAkDkC,GAAlD,CAAsDF,CAAtD,CACH,CAJD,CAeAxB,CAAW,CAACQ,SAAZ,CAAsBmB,WAAtB,CAAoC,SAAUC,CAAV,CAAiBjB,CAAjB,CAA6BC,CAA7B,CAAuC,CAEvE,GAAIiB,CAAAA,CAAI,CAAGrC,CAAC,CAAC,KAAKW,OAAL,CAAa2B,IAAb,CAAkB,gBAAlB,CAAD,CAAZ,CAEAtC,CAAC,CAAC,2BAAD,CAAD,CAA6BuC,IAA7B,GAGAF,CAAI,CAACG,OAAL,CAAa,iBAAb,EAGAjC,CAAK,CAACkC,oBAAN,CAA2BJ,CAAI,CAAC,CAAD,CAA/B,EAVuE,GAanEK,CAAAA,CAAI,CAAGL,CAAI,CAACM,SAAL,EAb4D,CAcnEC,CAAY,CAAG,KAAKjC,OAAL,CAAakC,IAAb,CAAkB,mBAAlB,CAdoD,CAiBvExC,CAAI,CAACyC,IAAL,CAAU,CAAC,CACPC,UAAU,CAAE,gCADL,CAEPC,IAAI,CAAE,CACFJ,YAAY,CAAEA,CADZ,CAEFK,MAAM,CAAE,KAAKhC,WAFX,CAGFiC,YAAY,CAAEC,IAAI,CAACC,SAAL,CAAeV,CAAf,CAHZ,CAFC,CAOPW,IAAI,CAAE,KAAKC,6BAAL,CAAmCC,IAAnC,CAAwC,IAAxC,CAA8Cb,CAA9C,CAAoDvB,CAApD,CAAgEC,CAAhE,CAPC,CAQPoC,IAAI,CAAEtD,CAAY,CAACuD,SARZ,CAAD,CAAV,CAUH,CA3BD,CAuCAjD,CAAW,CAACQ,SAAZ,CAAsBsC,6BAAtB,CAAsD,SAAUI,CAAV,CAAoBvC,CAApB,CAAgCC,CAAhC,CAA0CuC,CAA1C,CAAoD,CACtG,GAA0B,WAAtB,QAAOxC,CAAAA,CAAX,CAAuC,CACnCA,CAAU,CAAG,KAAKF,WACrB,CACD,GAAI0C,CAAQ,CAACC,MAAb,CAAqB,CAGjB5D,CAAC,CAAC6D,QAAD,CAAD,CAAYrB,OAAZ,CAAoB,OAApB,CAA6B,CAAC,KAAKvB,WAAN,CAAmByC,CAAnB,CAA7B,CACH,CAJD,IAIO,CACHpD,CAAG,CAACwD,WAAJ,CAAgB,CAAC,CACTC,GAAG,CAAE,cADI,CAETC,SAAS,CAAE,MAFF,CAAD,CAIZ,CACID,GAAG,CAAE,yBADT,CAEIC,SAAS,CAAE,2BAFf,CAJY,CAAhB,EAQGX,IARH,CAQQ,SAAUY,CAAV,CAAgB,CACpB/D,CAAY,CAACgE,KAAb,CAAmBD,CAAI,CAAC,CAAD,CAAvB,CAA4BA,CAAI,CAAC,CAAD,CAAhC,CACH,CAVD,EAUGT,IAVH,CAUQtD,CAAY,CAACuD,SAVrB,EAWAxD,CAAC,CAACkE,GAAF,CAAM,+BAAN,CAAuC,UAAY,CAC/CC,CAAC,CAACC,sBAAF,CAAyBC,sBAAzB,EACH,CAFD,EAGA,GAAInD,CAAU,EAAI,KAAKF,WAAvB,CAAoC,CAChCjB,CAAC,CAAC6D,QAAD,CAAD,CAAYrB,OAAZ,CAAoB,OAApB,CAA6BrB,CAA7B,CACH,CAFD,IAEO,IAAIC,CAAJ,CAAc,CACjBpB,CAAC,CAAC6D,QAAD,CAAD,CAAYrB,OAAZ,CAAoB,uBAApB,IACH,CAFM,IAEA,CACHxC,CAAC,CAAC6D,QAAD,CAAD,CAAYrB,OAAZ,CAAoB,cAApB,CAAoCrB,CAApC,CACH,CACJ,CACDnB,CAAC,CAAC,2BAAD,CAAD,CAA6BuE,IAA7B,EACH,CAhCD,CA2CA/D,CAAW,CAACQ,SAAZ,CAAsBwD,UAAtB,CAAmC,SAAUC,CAAV,CAAaxB,CAAb,CAAqBS,CAArB,CAA+B,CAE9D,GAAItB,CAAAA,CAAK,CAAGpC,CAAC,CAACO,KAAF,CAAQ,QAAR,CAAZ,CACA,GAAqB,WAAjB,QAAO0C,CAAAA,CAAX,CAAkC,CAC9BA,CAAM,CAAG,KAAKhC,WACjB,CACD,KAAKA,WAAL,CAAmB,CAAnB,CACA,KAAKyD,oBAAL,CAA0BtC,CAA1B,CAAiCa,CAAjC,CAAyCS,CAAzC,CACH,CARD,CAiBAlD,CAAW,CAACQ,SAAZ,CAAsB2D,cAAtB,CAAuC,SAAUF,CAAV,CAAa,IAI5CG,CAAAA,CAAI,CAAG5E,CAAC,CAACyE,CAAC,CAACI,MAAH,CAJoC,CAK5CC,CAAa,CAAGF,CAAI,CAAClC,IAAL,CAAU,aAAV,CAL4B,CAM5CqC,CAAe,CAAG/E,CAAC,CAAC6D,QAAQ,CAACmB,cAAT,CAAwBF,CAAxB,CAAD,CANyB,CAO5CG,CAAQ,CAAGF,CAAe,CAACG,KAAhB,EAPiC,CAQ5CC,CAAQ,CAAGF,CAAQ,CAACG,IAAT,CAAcpF,CAAC,CAAC,SAAD,CAAf,EAA4BuB,IAA5B,EARiC,CAUhDjB,CAAG,CAACwD,WAAJ,CAAgB,CAAC,CACTC,GAAG,CAAE,uBADI,CAETC,SAAS,CAAE,2BAFF,CAAD,CAIZ,CACID,GAAG,CAAE,MADT,CAEIC,SAAS,CAAE,MAFf,CAJY,CAQZ,CACID,GAAG,CAAE,QADT,CAEIC,SAAS,CAAE,MAFf,CARY,CAAhB,EAYGX,IAZH,CAYQ,SAAUY,CAAV,CAAgB,CACpB/D,CAAY,CAACmF,OAAb,CAAqBpB,CAAI,CAAC,CAAD,CAAzB,CAA8BkB,CAA9B,CAAwClB,CAAI,CAAC,CAAD,CAA5C,CAAiDA,CAAI,CAAC,CAAD,CAArD,CAA0D,UAAY,CAClE,GAAIqB,CAAAA,CAAa,CAAGtF,CAAC,CAAC,kDAAD,CAAD,CAAsDkC,GAAtD,EAApB,CAEA,KAAKwC,oBAAL,CAA0B,IAA1B,CAAgC,KAAKzD,WAArC,CAAkD,EAAlD,CAAsDqE,CAAtD,CACH,CAJyD,CAIxD/B,IAJwD,CAInD,IAJmD,CAA1D,CAKH,CANO,CAMNA,IANM,CAMD,IANC,CAZR,EAkBcC,IAlBd,CAkBmBtD,CAAY,CAACuD,SAlBhC,CAmBH,CA7BD,CAsCAjD,CAAW,CAACQ,SAAZ,CAAsBuE,iBAAtB,CAA0C,SAAU9E,CAAV,CAAoB,CAC1D,GAAI+E,CAAAA,CAAM,CAAGxF,CAAC,CAACS,CAAD,CAAd,CAEAN,CAAS,CAACsF,MAAV,CAAiB,yCAAjB,CAA4D,EAA5D,EAAgEpC,IAAhE,CAAqE,SAAU9B,CAAV,CAAgB,CACjF,GAAImE,CAAAA,CAAO,CAAGF,CAAM,CAAClD,IAAP,CAAY,2FAAZ,EACTqD,OADS,CACD,QADC,CAAd,CAEAD,CAAO,CAACE,QAAR,CAAiB,YAAjB,EAA+BtD,IAA/B,CAAoC,OAApC,EAA6CuD,MAA7C,GAAsDC,MAAtD,CAA6DvE,CAA7D,EAEAiE,CAAM,CAACO,EAAP,CAAU,OAAV,CAAmB,iCAAnB,CAAoD,KAAKC,aAAL,CAAmBzC,IAAnB,CAAwB,IAAxB,CAApD,CACH,CANoE,CAMnEA,IANmE,CAM9D,IAN8D,CAArE,EAMcC,IANd,CAMmBtD,CAAY,CAACuD,SANhC,CAOH,CAVD,CAmBAjD,CAAW,CAACQ,SAAZ,CAAsBgF,aAAtB,CAAsC,SAAU5D,CAAV,CAAiB,CACnDA,CAAK,CAAC6D,cAAN,GACA,GAAIC,CAAAA,CAAS,CAAGlG,CAAC,CAACoC,CAAK,CAACyC,MAAP,CAAD,CAAgBc,OAAhB,CAAwB,QAAxB,CAAhB,CACA,GAAIO,CAAS,CAACC,QAAV,CAAmB,QAAnB,CAAJ,CAAkC,CAC9BnG,CAAC,CAAC,SAAD,CAAD,CAAaoG,WAAb,CAAyB,QAAzB,CACH,CAFD,IAEO,CACHpG,CAAC,CAAC,SAAD,CAAD,CAAaoG,WAAb,CAAyB,QAAzB,EACAF,CAAS,CAACN,QAAV,CAAmB,QAAnB,EACAM,CAAS,CAACN,QAAV,CAAmB,mBAAnB,CACH,CACJ,CAVD,CAsBApF,CAAW,CAACQ,SAAZ,CAAsB0D,oBAAtB,CAA6C,SAAUtC,CAAV,CAAiBa,CAAjB,CAAwD,CACjF,KAAKtC,OAAL,CAAakC,IAAb,CAAkB,gBAAlB,CADiF,CAIjG,GAAI,KAAK5B,WAAL,EAAoBgC,CAAxB,CAAgC,CAC5B,MACH,CACD,KAAKhC,WAAL,CAAmBgC,CAAnB,CAEAjD,CAAC,CAAC6D,QAAD,CAAD,CAAYrB,OAAZ,CAAoB,oBAApB,EAEA6D,MAAM,CAACjC,CAAP,CAASkC,IAAT,CAAcC,UAAd,CAAyB,wCAAzB,EAEApG,CAAS,CAACsF,MAAV,CAAiB,yCAAjB,CAA4D,EAA5D,EAAgEpC,IAAhE,CAAqE,SAAU9B,CAAV,CAAgBC,CAAhB,CAAoB,CAKrF,KAAKb,OAAL,CAAagB,OAAb,CAAqB,MAArB,CAA6B,UAAY,CACrCxB,CAAS,CAACyB,mBAAV,CAA8B,KAAKjB,OAAnC,CAA4CY,CAA5C,CAAkDC,CAAlD,EACA,KAAKb,OAAL,CAAakB,MAAb,CAAoB,MAApB,CACH,CAH4B,CAG3B0B,IAH2B,CAGtB,IAHsB,CAA7B,CA6CH,CAlDoE,CAkDnEA,IAlDmE,CAkD9D,IAlD8D,CAArE,EAkDcC,IAlDd,CAkDmBtD,CAAY,CAACuD,SAlDhC,CAmDH,CAhED,CA0EAjD,CAAW,CAACQ,SAAZ,CAAsBwF,YAAtB,CAAqC,SAAUpE,CAAV,CAAiBM,CAAjB,CAAuB,CACxD,KAAKvB,UAAL,CAAkBuB,CAAI,CAACvB,UAAvB,CACA,KAAKC,QAAL,CAAgBsB,CAAI,CAACtB,QACxB,CAHD,CAWAZ,CAAW,CAACQ,SAAZ,CAAsByF,sBAAtB,CAA+C,UAAY,CACvD,KAAKtE,WAAL,CAAiB,IAAjB,CAAuB,KAAKhB,UAA5B,CAAwC,KAAKC,QAA7C,CACH,CAFD,CAUAZ,CAAW,CAACQ,SAAZ,CAAsB0F,eAAtB,CAAwC,UAAY,CAChD,MAAO1G,CAAAA,CAAC,CAAC,+BAAD,CACX,CAFD,CASAQ,CAAW,CAACQ,SAAZ,CAAsB2F,aAAtB,CAAsC,UAAY,CAC9C,KAAKD,eAAL,GAAuBd,QAAvB,CAAgC,WAAhC,CACH,CAFD,CASApF,CAAW,CAACQ,SAAZ,CAAsB4F,WAAtB,CAAoC,UAAY,CAC5C,KAAKF,eAAL,GAAuBN,WAAvB,CAAmC,WAAnC,CACH,CAFD,CASA5F,CAAW,CAACQ,SAAZ,CAAsBD,sBAAtB,CAA+C,UAAY,IACnD8F,CAAAA,CAAU,CAAG7G,CAAC,CAAC6D,QAAD,CADqC,CAEnD2B,CAAM,CAAGxF,CAAC,CAAC,KAAKW,OAAN,CAFyC,CAIvD6E,CAAM,CAACO,EAAP,CAAU,QAAV,CAAoB,MAApB,CAA4B,SAAUtB,CAAV,CAAa,CACrCA,CAAC,CAACwB,cAAF,EACH,CAFD,EAIAY,CAAU,CAACd,EAAX,CAAc,WAAd,CAA2B,KAAKS,YAAL,CAAkBjD,IAAlB,CAAuB,IAAvB,CAA3B,EACAsD,CAAU,CAACd,EAAX,CAAc,cAAd,CAA8B,KAAKrB,oBAAL,CAA0BnB,IAA1B,CAA+B,IAA/B,CAA9B,EACAsD,CAAU,CAACd,EAAX,CAAc,cAAd,CAA8B,KAAK5D,WAAL,CAAiBoB,IAAjB,CAAsB,IAAtB,CAA9B,EACAsD,CAAU,CAACd,EAAX,CAAc,oBAAd,CAAoC,KAAKU,sBAAL,CAA4BlD,IAA5B,CAAiC,IAAjC,CAApC,EACAsD,CAAU,CAACd,EAAX,CAAc,iBAAd,CAAiC,KAAKhE,cAAL,CAAoBwB,IAApB,CAAyB,IAAzB,CAAjC,CAEH,CAdD,CAgBA,MAAO/C,CAAAA,CACV,CA7YC,CAAN","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript controller for the \"Viewer\" panel\n *\n * @module     report_reflectionexporter/viewer_panel\n * @package    report_reflectionexporter\n * @class      ViewerPanel\n * @copyright  2022 Veronica Bermegui\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'core/yui', 'core/notification', 'core/templates', 'core/fragment',\n        'core/ajax', 'core/str', , 'core/event'\n    ],\n    function ($, Y, notification, templates, fragment, ajax, str, Event) {\n\n        /**\n         * ViewerPanel class.\n         *\n         * @class ViewerPanel\n         * @param {String} selector The selector for the page region containing the user navigation.\n         */\n        var ViewerPanel = function (selector) {\n            this._regionSelector = selector;\n            this._region = $(selector);\n            this._userCache = [];\n            console.log(this);\n            this.registerEventListeners();\n        };\n\n        /** @type {String} Selector for the page region containing the user navigation. */\n        ViewerPanel.prototype._regionSelector = null;\n\n        /** @type {Integer} Remember the last user id to prevent unnessecary reloads. */\n        ViewerPanel.prototype._lastUserId = 0;\n\n        /** @type {Integer} Remember the last attempt number to prevent unnessecary reloads. */\n        ViewerPanel.prototype._lastAttemptNumber = -1;\n\n        /** @type {JQuery} JQuery node for the page region containing the user navigation. */\n        ViewerPanel.prototype._region = null;\n\n        /** @type {Integer} The id of the next user in the grading list */\n        ViewerPanel.prototype.nextUserId = null;\n\n        /** @type {Boolean} Next user exists in the grading list */\n        ViewerPanel.prototype.nextUser = false;\n\n        /**\n         * Fade the dom node out, update it, and fade it back.\n         *\n         * @private\n         * @method _niceReplaceNodeContents\n         * @param {JQuery} node\n         * @param {String} html\n         * @param {String} js\n         * @return {Deferred} promise resolved when the animations are complete.\n         */\n        ViewerPanel.prototype._niceReplaceNodeContents = function (node, html, js) {\n            var promise = $.Deferred();\n\n            node.fadeOut(\"fast\", function () {\n                templates.replaceNodeContents(node, html, js);\n                node.fadeIn(\"fast\", function () {\n                    promise.resolve();\n                });\n            });\n\n            return promise.promise();\n        };\n\n        /**\n         * Make sure all form fields have the latest saved state.\n         * @private\n         * @method _saveFormState\n         */\n        ViewerPanel.prototype._saveFormState = function () {\n            // Copy data from notify students checkbox which was moved out of the form.\n            var checked = $('[data-region=\"grading-actions-form\"] [name=\"sendstudentnotifications\"]').prop(\"checked\");\n            $('.gradeform [name=\"sendstudentnotifications\"]').val(checked);\n        };\n\n        /**\n         * Make form submit via ajax.\n         *\n         * @private\n         * @param {Object} event\n         * @param {Integer} nextUserId\n         * @param {Boolean} nextUser optional. Load next user in the grading list.\n         * @method _submitForm\n         */\n        ViewerPanel.prototype._submitForm = function (event, nextUserId, nextUser) {\n            // The form was submitted - send it via ajax instead.\n            var form = $(this._region.find('form.gradeform'));\n\n            $('[data-region=\"overlay\"]').show();\n\n            // We call this, so other modules can update the form with the latest state.\n            form.trigger('save-form-state');\n\n            // Tell all form fields we are about to submit the form.\n            Event.notifyFormSubmitAjax(form[0]);\n\n            // Now we get all the current values from the form.\n            var data = form.serialize();\n            var assignmentid = this._region.attr('data-assignmentid');\n\n            // Now we can continue...\n            ajax.call([{\n                methodname: 'mod_assign_submit_grading_form',\n                args: {\n                    assignmentid: assignmentid,\n                    userid: this._lastUserId,\n                    jsonformdata: JSON.stringify(data)\n                },\n                done: this._handleFormSubmissionResponse.bind(this, data, nextUserId, nextUser),\n                fail: notification.exception\n            }]);\n        };\n\n        /**\n         * Handle form submission response.\n         *\n         * @private\n         * @method _handleFormSubmissionResponse\n         * @param {Array} formdata - submitted values\n         * @param {Integer} nextUserId - optional. The id of the user to load after the form is saved.\n         * @param {Array} response List of errors.\n         * @param {Boolean} nextUser - optional. If true, switch to next user in the grading list.\n         */\n        ViewerPanel.prototype._handleFormSubmissionResponse = function (formdata, nextUserId, nextUser, response) {\n            if (typeof nextUserId === \"undefined\") {\n                nextUserId = this._lastUserId;\n            }\n            if (response.length) {\n                // There was an error saving the grade. Re-render the form using the submitted data so we can show\n                // validation errors.\n                $(document).trigger('reset', [this._lastUserId, formdata]);\n            } else {\n                str.get_strings([{\n                        key: 'changessaved',\n                        component: 'core'\n                    },\n                    {\n                        key: 'gradechangessaveddetail',\n                        component: 'report_reflectionexporter'\n                    },\n                ]).done(function (strs) {\n                    notification.alert(strs[0], strs[1]);\n                }).fail(notification.exception);\n                Y.use('moodle-core-formchangechecker', function () {\n                    M.core_formchangechecker.reset_form_dirty_state();\n                });\n                if (nextUserId == this._lastUserId) {\n                    $(document).trigger('reset', nextUserId);\n                } else if (nextUser) {\n                    $(document).trigger('done-saving-show-next', true);\n                } else {\n                    $(document).trigger('user-changed', nextUserId);\n                }\n            }\n            $('[data-region=\"overlay\"]').hide();\n        };\n\n        /**\n         * Refresh form with default values.\n         *\n         * @private\n         * @method _resetForm\n         * @param {Event} e\n         * @param {Integer} userid\n         * @param {Array} formdata\n         */\n        ViewerPanel.prototype._resetForm = function (e, userid, formdata) {\n            // The form was cancelled - refresh with default values.\n            var event = $.Event(\"custom\");\n            if (typeof userid == \"undefined\") {\n                userid = this._lastUserId;\n            }\n            this._lastUserId = 0;\n            this._refreshGradingPanel(event, userid, formdata);\n        };\n\n        /**\n         * Open a picker to choose an older attempt.\n         *\n         * @private\n         * @param {Object} e\n         * @method _chooseAttempt\n         */\n        ViewerPanel.prototype._chooseAttempt = function (e) {\n            // Show a dialog.\n\n            // The form is in the element pointed to by data-submissions.\n            var link = $(e.target);\n            var submissionsId = link.data('submissions');\n            var submissionsform = $(document.getElementById(submissionsId));\n            var formcopy = submissionsform.clone();\n            var formhtml = formcopy.wrap($('<form/>')).html();\n\n            str.get_strings([{\n                    key: 'viewadifferentattempt',\n                    component: 'report_reflectionexporter'\n                },\n                {\n                    key: 'view',\n                    component: 'core'\n                },\n                {\n                    key: 'cancel',\n                    component: 'core'\n                },\n            ]).done(function (strs) {\n                notification.confirm(strs[0], formhtml, strs[1], strs[2], function () {\n                    var attemptnumber = $(\"input:radio[name='select-attemptnumber']:checked\").val();\n\n                    this._refreshGradingPanel(null, this._lastUserId, '', attemptnumber);\n                }.bind(this));\n            }.bind(this)).fail(notification.exception);\n        };\n\n        /**\n         * Add popout buttons\n         *\n         * @private\n         * @method _addPopoutButtons\n         * @param {JQuery} selector The region selector to add popout buttons to.\n         */\n        ViewerPanel.prototype._addPopoutButtons = function (selector) {\n            var region = $(selector);\n\n            templates.render('report_reflectionexporter/popout_button', {}).done(function (html) {\n                var parents = region.find('[data-fieldtype=\"filemanager\"],[data-fieldtype=\"editor\"],[data-fieldtype=\"grading\"]')\n                    .closest('.fitem');\n                parents.addClass('has-popout').find('label').parent().append(html);\n\n                region.on('click', '[data-region=\"popout-button\"]', this._togglePopout.bind(this));\n            }.bind(this)).fail(notification.exception);\n        };\n\n        /**\n         * Make a div \"popout\" or \"popback\".\n         *\n         * @private\n         * @method _togglePopout\n         * @param {Event} event\n         */\n        ViewerPanel.prototype._togglePopout = function (event) {\n            event.preventDefault();\n            var container = $(event.target).closest('.fitem');\n            if (container.hasClass('popout')) {\n                $('.popout').removeClass('popout');\n            } else {\n                $('.popout').removeClass('popout');\n                container.addClass('popout');\n                container.addClass('moodle-has-zindex');\n            }\n        };\n\n        /**\n         * Get the user context - re-render the template in the page.\n         *\n         * @private\n         * @method _refreshGradingPanel\n         * @param {Event} event\n         * @param {Number} userid\n         * @param {String} submissiondata serialised submission data.\n         * @param {Integer} attemptnumber\n         */\n        ViewerPanel.prototype._refreshGradingPanel = function (event, userid, submissiondata, attemptnumber) {\n            var contextid = this._region.attr('data-contextid');\n\n            // Skip reloading if it is the same user.\n            if (this._lastUserId == userid) {\n                return;\n            }\n            this._lastUserId = userid;\n\n            $(document).trigger('start-loading-user');\n            // Tell behat to back off too.\n            window.M.util.js_pending('report-reflectionexporter-loading-user');\n\n            templates.render('report_reflectionexporter/pdf_container', {}).done(function (html, js) {\n                // Update the page.\n\n                // Update the page.\n                // if (userid == this._lastUserId) {\n                this._region.fadeOut(\"fast\", function () {\n                    templates.replaceNodeContents(this._region, html, js);\n                    this._region.fadeIn(\"fast\");\n                }.bind(this));\n\n                // Load pdf.\n                //   viewPDF.init(context.pdf);\n\n                // }\n\n                // this._niceReplaceNodeContents(this._region, html, js).done(function () {\n                //     if (userid > 0) {\n                //         this._region.show();\n                //         // Reload the grading form \"fragment\" for this user.\n                //         var params = {\n                //             userid: userid,\n                //             attemptnumber: attemptnumber,\n                //             jsonformdata: JSON.stringify(submissiondata)\n                //         };\n                //         // fragment.loadFragment('report_reflectionexporter', 'gradingpanel', contextid, params).done(function (html, js) {\n                //         //     this._niceReplaceNodeContents(this._region, html, js)\n                //         //         .done(function () {\n                //         //             checker.saveFormState('[data-region=\"grade-panel\"] .gradeform');\n                //         //             $(document).on('editor-content-restored', function () {\n                //         //                 // If the editor has some content that has been restored\n                //         //                 // then save the form state again for comparison.\n                //         //                 checker.saveFormState('[data-region=\"grade-panel\"] .gradeform');\n                //         //             });\n                //         //             $('[data-region=\"attempt-chooser\"]').on('click', this._chooseAttempt.bind(this));\n                //         //             this._addPopoutButtons('[data-region=\"grade-panel\"] .gradeform');\n                //         //             $(document).trigger('finish-loading-user');\n                //         //             // Tell behat we are friends again.\n                //         //             window.M.util.js_complete('mod-assign-loading-user');\n                //         //         }.bind(this))\n                //         //         .fail(notification.exception);\n                //         // }.bind(this)).fail(notification.exception);\n                //         $('[data-region=\"viewer-panel\"]').show();\n                //     } else {\n                //         this._region.hide();\n                //         $('[data-region=\"viewer-panel\"]').hide();\n                //         $(document).trigger('finish-loading-user');\n                //         // Tell behat we are friends again.\n                //         window.M.util.js_complete('report-reflectionexporter-loading-user');\n                //     }\n                // }.bind(this));\n            }.bind(this)).fail(notification.exception);\n        };\n\n        /**\n         * Get next user data and store it in global variables\n         *\n         * @private\n         * @method _getNextUser\n         * @param {Event} event\n         * @param {Object} data Next user's data\n         */\n        ViewerPanel.prototype._getNextUser = function (event, data) {\n            this.nextUserId = data.nextUserId;\n            this.nextUser = data.nextUser;\n        };\n\n        /**\n         * Handle the save-and-show-next event\n         *\n         * @private\n         * @method _handleSaveAndShowNext\n         */\n        ViewerPanel.prototype._handleSaveAndShowNext = function () {\n            this._submitForm(null, this.nextUserId, this.nextUser);\n        };\n\n        /**\n         * Get the grade panel element.\n         *\n         * @method getPanelElement\n         * @return {jQuery}\n         */\n        ViewerPanel.prototype.getPanelElement = function () {\n            return $('[data-region=\"grade-panel\"]');\n        };\n\n        /**\n         * Hide the grade panel.\n         *\n         * @method collapsePanel\n         */\n        ViewerPanel.prototype.collapsePanel = function () {\n            this.getPanelElement().addClass('collapsed');\n        };\n\n        /**\n         * Show the grade panel.\n         *\n         * @method expandPanel\n         */\n        ViewerPanel.prototype.expandPanel = function () {\n            this.getPanelElement().removeClass('collapsed');\n        };\n\n        /**\n         * Register event listeners for the grade panel.\n         *\n         * @method registerEventListeners\n         */\n        ViewerPanel.prototype.registerEventListeners = function () {\n            var docElement = $(document);\n            var region = $(this._region);\n            // Add an event listener to prevent form submission when pressing enter key.\n            region.on('submit', 'form', function (e) {\n                e.preventDefault();\n            });\n\n            docElement.on('next-user', this._getNextUser.bind(this));\n            docElement.on('user-changed', this._refreshGradingPanel.bind(this));\n            docElement.on('save-changes', this._submitForm.bind(this));\n            docElement.on('save-and-show-next', this._handleSaveAndShowNext.bind(this));\n            docElement.on('save-form-state', this._saveFormState.bind(this));\n\n        };\n\n        return ViewerPanel;\n    });"],"file":"viewer_panel.min.js"}