{"version":3,"file":"tokexporter.min.js","sources":["../src/tokexporter.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Gets the Theory of Knowledge (TOK) ib form in PDF format and imports the\r\n * interactions and teacher comments into it.\r\n *\r\n * @package    report\r\n * @subpackage reflectionexporter\r\n * @copyright  2023 Veronica Bermegui\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n\r\ndefine([\r\n    \"jquery\",\r\n    \"core/ajax\",\r\n    \"core/log\",\r\n    \"report_reflectionexporter/pdf-lib\",\r\n    \"core/templates\",\r\n    \"report_reflectionexporter/reflectionexporterHelper\",\r\n\r\n], function ($, Ajax, Log, PDFLib, Templates, ReHelper) {\r\n    \"use strict\";\r\n\r\n    function init(data) {\r\n        var control = new Controls(data);\r\n        control.main();\r\n    }\r\n\r\n    /**\r\n     * The TextX name are the names the ib form in PDF format ha given to the fields.\r\n     * @param {*} data\r\n     */\r\n    function Controls(data) {\r\n\r\n        this.data = data;\r\n        this.tokFormInputs = ReHelper.get_tok_form_inputs();\r\n    }\r\n\r\n    /**\r\n     * Run the controller.\r\n     *\r\n     */\r\n    Controls.prototype.main = function () {\r\n        // Get the interactions data.\r\n\r\n        if (this.data.new == 1) {\r\n            this.getInteractionsjson()\r\n        } else {\r\n            this.getInteractionspdf();\r\n        }\r\n\r\n    };\r\n\r\n    Controls.prototype.getInteractionspdf = function () {\r\n\r\n        this.displayTemplate();\r\n    }\r\n\r\n    Controls.prototype.getInteractionsjson = async function () {\r\n        var self = this;\r\n\r\n        Ajax.call([{\r\n            methodname: \"report_reflectionexporter_get_reflections\",\r\n            args: {\r\n                rid: this.data.rid,\r\n            },\r\n            done: async function (response) {\r\n                const users = JSON.parse(response.reflecjson);\r\n                const pdfs = await self.processInteractions(users);\r\n                self.savePDFInDB(pdfs);\r\n\r\n            },\r\n            fail: function (reason) {\r\n                Log.error(reason);\r\n            },\r\n        },]);\r\n    };\r\n\r\n    /**\r\n     *  For each student, fill the form with the\r\n     *  data needed.\r\n     * @param {*} users\r\n     * @returns\r\n     */\r\n    Controls.prototype.processInteractions = async function (users) {\r\n        const studentpdfs = [];\r\n        for (var i = 0; i < users.length; i++) {\r\n            const pdf = await this.fillformAndSave(users[i]);\r\n            const student = {\r\n                uid: users[i].interactions[0].userid,\r\n                courseid: this.data.cid,\r\n                rid: this.data.rid,\r\n                pdf: pdf,\r\n                formname: this.data.ibform\r\n            };\r\n\r\n            studentpdfs.push(student);\r\n\r\n        }\r\n\r\n        return studentpdfs;\r\n\r\n    };\r\n\r\n    // Fill PDF with data and return the generted file in base64\r\n    Controls.prototype.fillformAndSave = async function (user) {\r\n        const formUrl = this.data.fileurl;\r\n        const formPdfBytes = await fetch(formUrl).then((res) => res.arrayBuffer());\r\n        const pdfDoc = await PDFLib.PDFDocument.load(formPdfBytes);\r\n        const form = pdfDoc.getForm();\r\n        const fields = form.getFields();\r\n\r\n        fields.forEach((field) => {\r\n            this.setFormFields(user, form, field);\r\n        });\r\n\r\n        // Return the base64 PDF\r\n        return await pdfDoc.saveAsBase64();\r\n\r\n    };\r\n\r\n    /**\r\n   * Fields to complete in the form.\r\n   * @param {*} user\r\n   * @param {*} form\r\n   * @param {*} field\r\n   */\r\n    Controls.prototype.setFormFields = async function (user, form, field) {\r\n        var self = this;\r\n        const fieldName = field.getName();\r\n\r\n        switch (fieldName) {\r\n            case self.tokFormInputs.CANDIDATE_PERSONAL_CODE:\r\n                form.getTextField(fieldName).setText(String(user.id));\r\n                break;\r\n            case self.tokFormInputs.SESSION:\r\n                form.getTextField(fieldName).setText(String(user.session));\r\n                break;\r\n            case self.tokFormInputs.PRESCRIBED_TITLE:\r\n                form.getTextField(fieldName).setText(String(user.prescribedtitle));\r\n                break;\r\n            case self.tokFormInputs.FIRST_INTERACTION_CANDIDATE_COMMENTS:\r\n\r\n                form.getTextField(fieldName).setText((user.interactions[0].plaintext).replaceAll('\"', ''));\r\n                break;\r\n            case self.tokFormInputs.FIRST_INTERACTION_CANDIDATE_DATE:\r\n                form.getTextField(fieldName).setText(user.interactions[0].month);\r\n                break;\r\n            case self.tokFormInputs.SECOND_INTERACTION_CANDIDATE_COMMENTS:\r\n                form.getTextField(fieldName).setText((user.interactions[1].plaintext).replaceAll('\"', ''));\r\n                break;\r\n            case self.tokFormInputs.SECOND_INTERACTION_CANDIDATE_DATE:\r\n                form.getTextField(fieldName).setText(user.interactions[1].month);\r\n                break;\r\n            case self.tokFormInputs.THIRD_INTERACTION_CANDIDATE_COMMENTS:\r\n                form.getTextField(fieldName).setText((user.interactions[2].plaintext.replaceAll('\"', '')));\r\n                break;\r\n            case self.tokFormInputs.THIRD_INTERACTION_CANDIDATE_DATE:\r\n                form.getTextField(fieldName).setText(user.interactions[2].month);\r\n                break;\r\n            case self.tokFormInputs.TEACHER_COMMENTS:\r\n                form.getTextField(fieldName).setText(user.comments);\r\n                break;\r\n            case self.tokFormInputs.COMPLETED_CANDIDATE_NAME:\r\n                form.getTextField(fieldName).setText(`${user.firstname} ${user.lastname}`);\r\n                break;\r\n            case self.tokFormInputs.COMPLETED_CANDIDATE_SESSION_NUMBER:\r\n                form.getTextField(fieldName).setText(user.session);\r\n                break;\r\n            case self.tokFormInputs.COMPLETED_DECLARATION_DATE1:\r\n                form.getTextField(fieldName).setText(user.month);\r\n                break;\r\n            case self.tokFormInputs.COMPLETED_DECLARATION_TEACHER_NAME:\r\n                form.getTextField(fieldName).setText(user.teachersname);\r\n                break;\r\n            case self.tokFormInputs.COMPLETED_DECLARATION_DATE2:\r\n                form.getTextField(fieldName).setText(user.month);\r\n                break;\r\n            case self.tokFormInputs.COMPLETED_DECLARATION_SCHOOL_NAME:\r\n                form.getTextField(fieldName).setText(user.schoolname);\r\n                break;\r\n            case self.tokFormInputs.COMPLETED_DECLARATION_SCHOOL_NUMBER:\r\n                form.getTextField(fieldName).setText(user.schoolnumber);\r\n                break;\r\n\r\n        }\r\n    };\r\n\r\n    // Call WS to save pdf data in DB (table mdl_report_reflec_exporter_pdf).\r\n    Controls.prototype.savePDFInDB = function (pdfs) {\r\n        var self = this;\r\n\r\n        const pdfjson = JSON.stringify(pdfs);\r\n\r\n        Ajax.call([{\r\n            methodname: \"report_reflectionexporter_save_pdfbase64\",\r\n            args: {\r\n                pdfs: pdfjson,\r\n            },\r\n            done: function (response) {\r\n                const downloadurl = new URL(window.location.href);\r\n                downloadurl.searchParams.append('d', 1);\r\n                const context = {\r\n                    pdfjson: response.savedrecords,\r\n                    courseid: self.data.cid,\r\n                    coursename: self.data.coursename,\r\n                    showuseridentity: true,\r\n                    reflecid: self.data.rid,\r\n                    firstuserid: 0,\r\n                }\r\n\r\n                Templates.render('report_reflectionexporter/viewer', context)\r\n                    .done(function (html, js) {\r\n                        $(document.querySelector('.importing-animation')).fadeOut(\"fast\", function () {\r\n                            Templates.replaceNodeContents($(document.querySelector('.importing-animation')), html, js);\r\n                            $(document.querySelector('.importing-animation')).fadeIn(\"fast\");\r\n                        }.bind(this));\r\n                    }).fail(function (ex) {\r\n                        console.log(ex);\r\n                    });\r\n\r\n            },\r\n            fail: function (reason) {\r\n                Log.error(reason);\r\n            },\r\n        },]);\r\n\r\n    }\r\n\r\n    Controls.prototype.displayTemplate = function () {\r\n        var self = this;\r\n        const context = {\r\n            pdfjson: self.data.pdfjson,\r\n            courseid: self.data.cid,\r\n            coursename: self.data.coursename,\r\n            showuseridentity: true,\r\n            reflecid: self.data.rid,\r\n            firstuserid: 0,\r\n            // tkform: self.data.ibform === 'TK_PPF',\r\n        }\r\n\r\n        console.log(context);\r\n\r\n        Templates.render('report_reflectionexporter/viewer', context)\r\n            .done(function (html, js) {\r\n                $(document.querySelector('.importing-animation')).fadeOut(\"fast\", function () {\r\n                    Templates.replaceNodeContents($(document.querySelector('.importing-animation')), html, js);\r\n                    $(document.querySelector('.importing-animation')).fadeIn(\"fast\");\r\n                }.bind(this));\r\n            }).fail(function (ex) {\r\n                console.log(ex);\r\n            });\r\n    }\r\n\r\n    return {\r\n        init: init,\r\n    };\r\n\r\n\r\n\r\n\r\n})\r\n"],"names":["define","$","Ajax","Log","PDFLib","Templates","ReHelper","Controls","data","tokFormInputs","get_tok_form_inputs","prototype","main","this","new","getInteractionsjson","getInteractionspdf","displayTemplate","async","self","call","methodname","args","rid","done","response","users","JSON","parse","reflecjson","pdfs","processInteractions","savePDFInDB","fail","reason","error","studentpdfs","i","length","pdf","fillformAndSave","student","uid","interactions","userid","courseid","cid","formname","ibform","push","user","formUrl","fileurl","formPdfBytes","fetch","then","res","arrayBuffer","pdfDoc","PDFDocument","load","form","getForm","getFields","forEach","field","setFormFields","saveAsBase64","fieldName","getName","CANDIDATE_PERSONAL_CODE","getTextField","setText","String","id","SESSION","session","PRESCRIBED_TITLE","prescribedtitle","FIRST_INTERACTION_CANDIDATE_COMMENTS","plaintext","replaceAll","FIRST_INTERACTION_CANDIDATE_DATE","month","SECOND_INTERACTION_CANDIDATE_COMMENTS","SECOND_INTERACTION_CANDIDATE_DATE","THIRD_INTERACTION_CANDIDATE_COMMENTS","THIRD_INTERACTION_CANDIDATE_DATE","TEACHER_COMMENTS","comments","COMPLETED_CANDIDATE_NAME","firstname","lastname","COMPLETED_CANDIDATE_SESSION_NUMBER","COMPLETED_DECLARATION_DATE1","COMPLETED_DECLARATION_TEACHER_NAME","teachersname","COMPLETED_DECLARATION_DATE2","COMPLETED_DECLARATION_SCHOOL_NAME","schoolname","COMPLETED_DECLARATION_SCHOOL_NUMBER","schoolnumber","pdfjson","stringify","URL","window","location","href","searchParams","append","context","savedrecords","coursename","showuseridentity","reflecid","firstuserid","render","html","js","document","querySelector","fadeOut","replaceNodeContents","fadeIn","bind","ex","console","log","init"],"mappings":"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"}