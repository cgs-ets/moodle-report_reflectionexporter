function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}
/**
 * Javascript to handle the PDF view
 *
 * @module     report_reflectionexporter/vew_pdf
 * @copyright  2022 Veronica Bermegui
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */define("report_reflectionexporter/view_pdf",["report_reflectionexporter/pdf","report_reflectionexporter/pdf-lib","core/templates","core/ajax","core/url"],(function(PDFJSLIB,PDFLib,Templates,Ajax,url){var _ref,ViewPDF=function(){$(document).on("user-changed",this._init.bind(this))};return ViewPDF.prototype._init=function(){var self=this;Templates.render("report_reflectionexporter/loading",{}).done((function(html,js){$('[data-region="pdf-comment-container"]').fadeOut("fast",function(){Templates.replaceNodeContents($('[data-region="pdf-comment-container"]'),html,js),$('[data-region="pdf-comment-container"]').fadeIn("fast")}.bind(this));var user=self._getUser();console.log(user),Ajax.call([{methodname:"report_reflectionexporter_get_pdfbase64",args:{recorid:user[0].id},done:function(response){var downloadurl=new URL(window.location.href);self.pdfData=response.pdfbase64,downloadurl.searchParams.append("d",1),self.completed="C"==user[0].status;var context={courseurl:document.getElementById("courseurl").getAttribute("href"),downloadaction:downloadurl,datajson:document.querySelector(".data-pdfjson").getAttribute("data-pdfs"),completed:"C"==user[0].status};console.log(context),Templates.render("report_reflectionexporter/pdf_container",context).done((function(html,js){Templates.replaceNodeContents($('[data-region="pdf-comment-container"]'),html,js);var pdfData=self.pdfData;PDFJSLIB.GlobalWorkerOptions.workerSrc=url.relativeUrl("/report/reflectionexporter/amd/src/pdf.worker.js");var loadingTask=PDFJSLIB.getDocument({data:atob(pdfData)}),currPage=1,numPages=0,thePDF=null;function handlePages(_x){return _handlePages.apply(this,arguments)}function _handlePages(){return _handlePages=_asyncToGenerator(regeneratorRuntime.mark((function _callee(page){var viewport,canvas,context;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return viewport=page.getViewport({scale:1.5}),(canvas=document.createElement("canvas")).classList.add("pdf-page"),canvas.height=viewport.height,canvas.width=viewport.width,context=canvas.getContext("2d"),_context.next=8,page.render({canvasContext:context,viewport:viewport});case 8:document.getElementById("viewer").appendChild(canvas),currPage++,null!==thePDF&&currPage<=numPages&&thePDF.getPage(currPage).then(handlePages);case 11:case"end":return _context.stop()}}),_callee)}))),_handlePages.apply(this,arguments)}if(loadingTask.promise.then((function(pdf){thePDF=pdf,numPages=pdf.numPages,pdf.getPage(1).then(handlePages).catch((function(error){return console.log(error)}))}),(function(reason){console.error(reason)})),self.completed){document.querySelector("h4.reflection-completed").classList.add("reflection-completed-display"),document.querySelector("h4.reflection-completed").classList.remove("reflection-completed");var select=document.querySelector("[data-action='change-user']");null==select.options[select.selectedIndex].nextElementSibling&&self._enableDownloadAndSummary()}else document.querySelector("form.reflection-comment-form").removeAttribute("hidden"),document.querySelector("button.save-show-next-btn").addEventListener("click",self._saveshownext.bind(self)),document.querySelector("button.save-exit-btn").addEventListener("click",self._savesandexit.bind(self))}))},fail:function(reason){console.log(reason)}}])}))},ViewPDF.prototype._getUser=function(){var userid=$('[data-action="change-user"]')[0].getAttribute("data-selected");return JSON.parse(document.querySelector("div.data-pdfjson").getAttribute("data-pdfs")).filter((function(user){if(user.userid==userid)return user}))},ViewPDF.prototype._getUserId=function(){return $('[data-action="change-user"]')[0].getAttribute("data-selected")},ViewPDF.prototype._saveshownext=function(e){e.preventDefault(),console.log(e),this._save("shownext")},ViewPDF.prototype._save=(_ref=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(btnClicked){var commentEl,pdfData,stringPdfToBinary,pdfDoc,form,pdf,user,select,toUpdate;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(0!==(commentEl=document.getElementById("comment")).value.length){_context2.next=6;break}return commentEl.classList.add("comment_error"),_context2.abrupt("return");case 6:return commentEl.classList.remove("comment_error"),pdfData=this.pdfData,stringPdfToBinary=Uint8Array.from(atob(pdfData),(function(c){return c.charCodeAt(0)})),_context2.next=11,PDFLib.PDFDocument.load(stringPdfToBinary);case 11:return pdfDoc=_context2.sent,(form=pdfDoc.getForm()).getField("Text12").setText(commentEl.value),form.flatten(),_context2.next=18,pdfDoc.saveAsBase64();case 18:pdf=_context2.sent,user=this._getUser(),select=document.querySelector("[data-action='change-user']"),toUpdate={id:user[0].id,userid:$('[data-action="change-user"]')[0].getAttribute("data-selected"),courseid:$('[data-region="user-info"]')[0].getAttribute("data-userid"),refexid:$('[data-region="user-info"]')[0].getAttribute("data-rid"),pdf:pdf,exit:"0",finished:null==select.options[select.selectedIndex].nextElementSibling?"1":"0"},"shownext"!=btnClicked&&(toUpdate.exit="1"),this._updatePDFInDB(toUpdate);case 24:case"end":return _context2.stop()}}),_callee2,this)}))),function(_x2){return _ref.apply(this,arguments)}),ViewPDF.prototype._updatePDFInDB=function(record){var self=this,arg=JSON.stringify(record),exit=record.exit;Ajax.call([{methodname:"report_reflectionexporter_update_pdfbase64",args:{pdf:arg},done:function(response){if(console.log(response),"1"!=exit){self._updatejson();var userid=document.querySelector("[data-action='change-user']").getAttribute("data-selected"),useridnumber=parseInt(userid,10),select=document.querySelector("[data-action='change-user']");if(document.getElementById("comment").value="",null!=select.options[select.selectedIndex].nextElementSibling){var nextuser=select.options[select.selectedIndex].nextElementSibling.value;select.setAttribute("data-selected",nextuser),select.value=String(nextuser),!isNaN(useridnumber)&&useridnumber>0&&$(document).trigger("user-changed",nextuser)}else $(document).trigger("user-changed",userid)}else window.location.replace(document.getElementById("courseurl").getAttribute("href"))},fail:function(reason){console.log(reason)}}])},ViewPDF.prototype._zipdownload=function(e){document.getElementById("zipform").submit()},ViewPDF.prototype._savesandexit=function(e){e.preventDefault(),this._save("showexit")},ViewPDF.prototype._updatejson=function(){for(var json=JSON.parse(document.querySelector(".data-pdfjson").getAttribute("data-pdfs")),userid=document.querySelector("[data-action='change-user']").getAttribute("data-selected"),i=0;i<json.length;i++)if(json[i].userid==userid){json[i].status="C";break}document.querySelector(".data-pdfjson").setAttribute("data-pdfs",JSON.stringify(json))},ViewPDF.prototype._enableDownloadAndSummary=function(){document.querySelector("div.next-action").classList.remove("next-action-hidden"),document.getElementById("download").addEventListener("click",this._zipdownload);var notprocess=document.querySelector(".importing-animation").getAttribute("data-notprocess");notprocess=parseInt(notprocess,10),console.log("NOT PROCESS"),console.log(notprocess),notprocess>0&&(document.getElementById("summary").classList.remove("btn-summary-hidden"),document.getElementById("summary").addEventListener("click",this._loadsummary))},ViewPDF.prototype._loadsummary=function(){Ajax.call([{methodname:"report_reflectionexporter_get_ommited",args:{recordid:document.querySelector('[data-region="viewer-navigation-panel"]').getAttribute("data-rid")},done:function(response){console.log(response);var context={students:JSON.parse(response.context)};console.log(context),Templates.render("report_reflectionexporter/students_table",context).done((function(html,js){Templates.replaceNodeContents(document.querySelector("div.omitted-table"),html,js);var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];modal.style.display="block",span.onclick=function(){modal.style.display="none"},window.onclick=function(event){event.target==modal&&(modal.style.display="none")}}))},fail:function(reason){console.log(reason)}}])},ViewPDF}));

//# sourceMappingURL=view_pdf.min.js.map