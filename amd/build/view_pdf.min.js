/**
 * Javascript to handle the PDF view
 *
 * @module     report_reflectionexporter/vew_pdf
 * @copyright  2022 Veronica Bermegui
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("report_reflectionexporter/view_pdf",["report_reflectionexporter/pdf","report_reflectionexporter/pdf-lib","report_reflectionexporter/reflectionexporterHelper","core/templates","core/ajax","core/url"],(function(PDFJSLIB,PDFLib,ReHelper,Templates,Ajax,url){var ViewPDF=function(){$(document).on("user-changed",this._init.bind(this))};return ViewPDF.prototype._init=function(){var self=this;Templates.render("report_reflectionexporter/loading",{}).done((function(html,js){const user=self._getUser();Ajax.call([{methodname:"report_reflectionexporter_get_pdfbase64",args:{recorid:user[0].id},done:function(response){const downloadurl=new URL(window.location.href),exporturl=new URL(window.location.href);let istkform=!1;self.pdfData=response.pdfbase64,downloadurl.searchParams.append("d",1),self.completed="C"==user[0].status,"TK_PPF"===ReHelper.get_ibform_name()&&(istkform=!0,exporturl.searchParams.append("export",1));const context={courseurl:document.getElementById("courseurl").getAttribute("href"),downloadaction:downloadurl,datajson:document.querySelector(".data-pdfjson").getAttribute("data-pdfs"),completed:"C"==user[0].status,tkform:istkform,exportspreadhseetaction:exporturl,summaryicon:url.imageUrl("clipboard","report_reflectionexporter"),zipicon:url.imageUrl("zip","report_reflectionexporter"),exporticon:url.imageUrl("spreadsheet","report_reflectionexporter"),rid:document.querySelector('[data-region="viewer-navigation-panel"]').getAttribute("data-rid"),title:"This form has been completed"};Templates.render("report_reflectionexporter/pdf_container",context).done((function(html,js){Templates.replaceNodeContents($('[data-region="pdf-comment-container"]'),html,js);const pdfData=self.pdfData;PDFJSLIB.GlobalWorkerOptions.workerSrc=url.relativeUrl("/report/reflectionexporter/amd/src/pdf.worker.js");var loadingTask=PDFJSLIB.getDocument({data:atob(pdfData)}),currPage=1,numPages=0,thePDF=null;async function handlePages(page){var viewport=page.getViewport({scale:1.5}),canvas=document.createElement("canvas");canvas.classList.add("pdf-page"),canvas.height=viewport.height,canvas.width=viewport.width;var context=canvas.getContext("2d");await page.render({canvasContext:context,viewport:viewport}),document.getElementById("viewer").appendChild(canvas),currPage++,null!==thePDF&&currPage<=numPages&&thePDF.getPage(currPage).then(handlePages)}if(loadingTask.promise.then((function(pdf){thePDF=pdf,numPages=pdf.numPages,pdf.getPage(1).then(handlePages).catch((error=>console.log(error)))}),(function(reason){console.log("loadingTask promise fail"),console.error(reason)})),self.completed){document.querySelector("h4.reflection-completed").classList.add("reflection-completed-display"),document.querySelector("h4.reflection-completed").classList.remove("reflection-completed");const select=document.querySelector("[data-action='change-user']");null==select.options[select.selectedIndex].nextElementSibling&&self._enableDownloadAndSummary()}else document.querySelector("form.reflection-comment-form").removeAttribute("hidden"),document.querySelector("button.save-show-next-btn").addEventListener("click",self._saveshownext.bind(self)),document.querySelector("button.save-exit-btn").addEventListener("click",self._savesandexit.bind(self))})).fail((function(error){console.error(error)}))},fail:function(reason){console.log(reason)}}])})).fail((function(error){console.error(error)}))},ViewPDF.prototype._getUser=function(){const userid=$('[data-action="change-user"]')[0].getAttribute("data-selected");return JSON.parse(document.querySelector("div.data-pdfjson").getAttribute("data-pdfs")).filter((user=>{if(user.userid==userid)return user}))},ViewPDF.prototype._getUserId=function(){return $('[data-action="change-user"]')[0].getAttribute("data-selected")},ViewPDF.prototype._saveshownext=function(e){e.preventDefault(),this._save("shownext")},ViewPDF.prototype._save=async function(btnClicked){const commentEl=document.getElementById("comment");if(0!==commentEl.value.length){commentEl.classList.remove("comment_error");const pdfData=this.pdfData,stringPdfToBinary=Uint8Array.from(atob(pdfData),(c=>c.charCodeAt(0))),pdfDoc=await PDFLib.PDFDocument.load(stringPdfToBinary),form=pdfDoc.getForm();let commentsupervisor;switch(ReHelper.get_ibform_name()){case"EE_RPPF":commentsupervisor=form.getField(ReHelper.get_ee_form_inputs().SUPERVISOR_COMMENT);break;case"TK_PPF":commentsupervisor=form.getField(ReHelper.get_tok_form_inputs().TEACHER_COMMENTS);var today=new Date;const options={year:"numeric",month:"numeric",day:"numeric"};today=today.toLocaleString("en-GB",options);const commentdate1=form.getField(ReHelper.get_tok_form_inputs().COMPLETED_DECLARATION_DATE1),commentdate2=form.getField(ReHelper.get_tok_form_inputs().COMPLETED_DECLARATION_DATE2);commentdate1.setText(today),commentdate2.setText(today)}commentsupervisor.setText(commentEl.value),form.flatten();const pdf=await pdfDoc.saveAsBase64(),user=this._getUser(),select=document.querySelector("[data-action='change-user']"),toUpdate={id:user[0].id,userid:$('[data-action="change-user"]')[0].getAttribute("data-selected"),courseid:$('[data-region="user-info"]')[0].getAttribute("data-userid"),refexid:$('[data-region="user-info"]')[0].getAttribute("data-rid"),pdf:pdf,exit:"0",finished:null==select.options[select.selectedIndex].nextElementSibling?"1":"0"};"shownext"!=btnClicked&&(toUpdate.exit="1"),this._updatePDFInDB(toUpdate)}else commentEl.classList.add("comment_error")},ViewPDF.prototype._updatePDFInDB=function(record){const self=this,arg=JSON.stringify(record),exit=record.exit;Ajax.call([{methodname:"report_reflectionexporter_update_pdfbase64",args:{pdf:arg},done:function(response){if("1"==exit)return void window.location.replace(document.getElementById("courseurl").getAttribute("href"));self._updatejson();const userid=document.querySelector("[data-action='change-user']").getAttribute("data-selected"),useridnumber=parseInt(userid,10),select=document.querySelector("[data-action='change-user']");if(document.getElementById("comment").value="",null!=select.options[select.selectedIndex].nextElementSibling){const nextuser=select.options[select.selectedIndex].nextElementSibling.value;select.setAttribute("data-selected",nextuser),select.value=String(nextuser),!isNaN(useridnumber)&&useridnumber>0&&$(document).trigger("user-changed",nextuser)}else $(document).trigger("user-changed",userid)},fail:function(reason){console.log(reason)}}])},ViewPDF.prototype._zipdownload=function(e){document.getElementById("zipform").submit()},ViewPDF.prototype._savesandexit=function(e){e.preventDefault(),this._save("showexit")},ViewPDF.prototype._updatejson=function(){const json=JSON.parse(document.querySelector(".data-pdfjson").getAttribute("data-pdfs")),userid=document.querySelector("[data-action='change-user']").getAttribute("data-selected");for(var i=0;i<json.length;i++)if(json[i].userid==userid){json[i].status="C";break}document.querySelector(".data-pdfjson").setAttribute("data-pdfs",JSON.stringify(json))},ViewPDF.prototype._enableDownloadAndSummary=function(){const self=this;document.querySelector("div.next-action").classList.remove("next-action-hidden"),document.getElementById("download").addEventListener("click",self._zipdownload);let notprocess=document.querySelector(".importing-animation").getAttribute("data-notprocess");notprocess=parseInt(notprocess,10),notprocess>0&&(document.getElementById("summary").classList.remove("btn-summary-hidden"),document.getElementById("summary").addEventListener("click",self._loadsummary)),"TK_PPF"===ReHelper.get_ibform_name()&&document.getElementById("export").addEventListener("click",self._spreadsheetdowndload)},ViewPDF.prototype._loadsummary=function(){Ajax.call([{methodname:"report_reflectionexporter_get_ommited",args:{recordid:document.querySelector('[data-region="viewer-navigation-panel"]').getAttribute("data-rid")},done:function(response){let context={students:JSON.parse(response.context)};Templates.render("report_reflectionexporter/students_table",context).done((function(html,js){Templates.replaceNodeContents(document.querySelector("div.omitted-table"),html,js);var modal=document.getElementById("myModal"),span=document.getElementsByClassName("close")[0];modal.style.display="block",span.onclick=function(){modal.style.display="none"},window.onclick=function(event){event.target==modal&&(modal.style.display="none")}}))},fail:function(reason){console.log(reason)}}])},ViewPDF.prototype._spreadsheetdowndload=function(){document.getElementById("exportspreadsheet").submit()},ViewPDF}));

//# sourceMappingURL=view_pdf.min.js.map