function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}f(void 0)})}}define ("report_reflectionexporter/view_pdf",["report_reflectionexporter/pdf","report_reflectionexporter/pdf-lib","core/templates","core/ajax","core/url"],function(a,b,c,d,e){"use strict";var f=function(){$(document).on("user-changed",this._init.bind(this))};f.prototype._init=function(){var b=this;c.render("report_reflectionexporter/loading",{}).done(function(f,g){$("[data-region=\"pdf-comment-container\"]").fadeOut("fast",function(){c.replaceNodeContents($("[data-region=\"pdf-comment-container\"]"),f,g);$("[data-region=\"pdf-comment-container\"]").fadeIn("fast")}.bind(this));var h=b._getUser();console.log(h);d.call([{methodname:"report_reflectionexporter_get_pdfbase64",args:{recorid:h[0].id},done:function done(d){var f=new URL(window.location.href);b.pdfData=d.pdfbase64;f.searchParams.append("d",1);b.completed="C"==h[0].status?!0:!1;var g={courseurl:document.getElementById("courseurl").getAttribute("href"),downloadaction:f,datajson:document.querySelector(".data-pdfjson").getAttribute("data-pdfs"),completed:"C"==h[0].status?!0:!1};console.log(g);c.render("report_reflectionexporter/pdf_container",g).done(function(d,f){c.replaceNodeContents($("[data-region=\"pdf-comment-container\"]"),d,f);var i=b.pdfData;a.GlobalWorkerOptions.workerSrc=e.relativeUrl("/report/reflectionexporter/amd/src/pdf.worker.js");var j=a.getDocument({data:atob(i)}),k=1,l=0,m=null;j.promise.then(function(a){m=a;l=a.numPages;a.getPage(1).then(g).catch(function(a){return console.log(a)})},function(a){console.error(a)});function g(){return h.apply(this,arguments)}function h(){h=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c,d,e;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c=b.getViewport({scale:1.5});d=document.createElement("canvas");d.classList.add("pdf-page");d.height=c.height;d.width=c.width;e=d.getContext("2d");a.next=8;return b.render({canvasContext:e,viewport:c});case 8:document.getElementById("viewer").appendChild(d);k++;if(null!==m&&k<=l){m.getPage(k).then(g)}case 11:case"end":return a.stop();}}},a)}));return h.apply(this,arguments)}if(!b.completed){document.querySelector("form.reflection-comment-form").removeAttribute("hidden");document.querySelector("button.save-show-next-btn").addEventListener("click",b._saveshownext.bind(b));document.querySelector("button.save-exit-btn").addEventListener("click",b._savesandexit.bind(b))}else{document.querySelector("h4.reflection-completed").classList.add("reflection-completed-display");document.querySelector("h4.reflection-completed").classList.remove("reflection-completed");var n=document.querySelector("[data-action='change-user']");if(null==n.options[n.selectedIndex].nextElementSibling){b._enableDownloadAndSummary()}}})},fail:function fail(a){console.log(a)}}])})};f.prototype._getUser=function(){var a=$("[data-action=\"change-user\"]")[0].getAttribute("data-selected"),b=JSON.parse(document.querySelector("div.data-pdfjson").getAttribute("data-pdfs")),c=b.filter(function(b){if(b.userid==a)return b});return c};f.prototype._getUserId=function(){return $("[data-action=\"change-user\"]")[0].getAttribute("data-selected")};f.prototype._saveshownext=function(a){a.preventDefault();console.log(a);this._save("shownext")};f.prototype._save=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(c){var d,e,f,g,h,i,j,k,l,m;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:d=document.getElementById("comment");if(!(0===d.value.length)){a.next=6;break}d.classList.add("comment_error");return a.abrupt("return");case 6:d.classList.remove("comment_error");e=this.pdfData;f=Uint8Array.from(atob(e),function(a){return a.charCodeAt(0)});a.next=11;return b.PDFDocument.load(f);case 11:g=a.sent;h=g.getForm();i=h.getField("Text12");i.setText(d.value);h.flatten();a.next=18;return g.saveAsBase64();case 18:j=a.sent;k=this._getUser();l=document.querySelector("[data-action='change-user']");m={id:k[0].id,userid:$("[data-action=\"change-user\"]")[0].getAttribute("data-selected"),courseid:$("[data-region=\"user-info\"]")[0].getAttribute("data-userid"),refexid:$("[data-region=\"user-info\"]")[0].getAttribute("data-rid"),pdf:j,exit:"0",finished:null==l.options[l.selectedIndex].nextElementSibling?"1":"0"};if("shownext"!=c){m.exit="1"}this._updatePDFInDB(m);case 24:case"end":return a.stop();}}},a,this)}));return function(){return a.apply(this,arguments)}}();f.prototype._updatePDFInDB=function(a){var b=this,c=JSON.stringify(a),e=a.exit;d.call([{methodname:"report_reflectionexporter_update_pdfbase64",args:{pdf:c},done:function done(a){console.log(a);if("1"==e){window.location.replace(document.getElementById("courseurl").getAttribute("href"));return}b._updatejson();var c=document.querySelector("[data-action='change-user']").getAttribute("data-selected"),d=parseInt(c,10),f=document.querySelector("[data-action='change-user']");document.getElementById("comment").value="";if(null!=f.options[f.selectedIndex].nextElementSibling){var g=f.options[f.selectedIndex].nextElementSibling.value;f.setAttribute("data-selected",g);f.value=g+"";if(!isNaN(d)&&0<d){$(document).trigger("user-changed",g)}}else{$(document).trigger("user-changed",c)}},fail:function fail(a){console.log(a)}}])};f.prototype._zipdownload=function(){document.getElementById("zipform").submit()};f.prototype._savesandexit=function(a){a.preventDefault();this._save("showexit")};f.prototype._updatejson=function(){var a=JSON.parse(document.querySelector(".data-pdfjson").getAttribute("data-pdfs")),b=document.querySelector("[data-action='change-user']").getAttribute("data-selected"),c=0;for(c;c<a.length;c++){if(a[c].userid==b){a[c].status="C";break}}document.querySelector(".data-pdfjson").setAttribute("data-pdfs",JSON.stringify(a))};f.prototype._enableDownloadAndSummary=function(){var a=this;document.querySelector("div.next-action").classList.remove("next-action-hidden");document.getElementById("download").addEventListener("click",a._zipdownload);var b=document.querySelector(".importing-animation").getAttribute("data-notprocess");b=parseInt(b,10);console.log("NOT PROCESS");console.log(b);if(0<b){document.getElementById("summary").classList.remove("btn-summary-hidden");document.getElementById("summary").addEventListener("click",a._loadsummary)}};f.prototype._loadsummary=function(){d.call([{methodname:"report_reflectionexporter_get_ommited",args:{recordid:document.querySelector("[data-region=\"viewer-navigation-panel\"]").getAttribute("data-rid")},done:function done(a){console.log(a);var b={students:JSON.parse(a.context)};console.log(b);c.render("report_reflectionexporter/students_table",b).done(function(a,b){c.replaceNodeContents(document.querySelector("div.omitted-table"),a,b);var d=document.getElementById("myModal"),e=document.getElementsByClassName("close")[0];d.style.display="block";e.onclick=function(){d.style.display="none"};window.onclick=function(a){if(a.target==d){d.style.display="none"}}})},fail:function fail(a){console.log(a)}}])};return f});
//# sourceMappingURL=view_pdf.min.js.map
