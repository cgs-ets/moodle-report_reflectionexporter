function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}f(void 0)})}}define ("report_reflectionexporter/view_pdf",["report_reflectionexporter/pdf","report_reflectionexporter/pdf-lib","core/templates","core/ajax","core/url"],function(a,b,c,d,e){"use strict";var f=function(){$(document).on("user-changed",this._init.bind(this))};f.prototype._init=function(){var b=this;c.render("report_reflectionexporter/loading",{}).done(function(f,g){$("[data-region=\"pdf-comment-container\"]").fadeOut("fast",function(){c.replaceNodeContents($("[data-region=\"pdf-comment-container\"]"),f,g);$("[data-region=\"pdf-comment-container\"]").fadeIn("fast")}.bind(this));var h=b._getUser();d.call([{methodname:"report_reflectionexporter_get_pdfbase64",args:{recorid:h[0].id},done:function done(d){b.pdfData=d.pdfbase64;var f=new URL(window.location.href);f.searchParams.append("d",1);var g={courseurl:document.getElementById("courseurl").getAttribute("href"),downloadaction:f,datajson:document.querySelector(".data-pdfjson").getAttribute("data-pdfs")};c.render("report_reflectionexporter/pdf_container",g).done(function(d,f){c.replaceNodeContents($("[data-region=\"pdf-comment-container\"]"),d,f);document.querySelector("button.save-show-next-btn").addEventListener("click",b._saveshownext.bind(b));var i=b.pdfData;a.GlobalWorkerOptions.workerSrc=e.relativeUrl("/report/reflectionexporter/amd/src/pdf.worker.js");var j=a.getDocument({data:atob(i)}),k=1,l=0,m=null;j.promise.then(function(a){m=a;l=a.numPages;a.getPage(1).then(g).catch(function(a){return console.log(a)})},function(a){console.error(a)});function g(){return h.apply(this,arguments)}function h(){h=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c,d,e;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c=b.getViewport({scale:1.5});d=document.createElement("canvas");d.classList.add("pdf-page");d.height=c.height;d.width=c.width;e=d.getContext("2d");a.next=8;return b.render({canvasContext:e,viewport:c});case 8:document.getElementById("viewer").appendChild(d);k++;if(null!==m&&k<=l){m.getPage(k).then(g)}case 11:case"end":return a.stop();}}},a)}));return h.apply(this,arguments)}})},fail:function fail(a){console.log(a)}}])})};f.prototype._getUser=function(){var a=$("[data-action=\"change-user\"]")[0].getAttribute("data-selected"),b=JSON.parse(document.querySelector("div.data-pdfjson").getAttribute("data-pdfs")),c=b.filter(function(b){if(b.userid==a)return b});return c};f.prototype._getUserId=function(){return $("[data-action=\"change-user\"]")[0].getAttribute("data-selected")};f.prototype._saveshownext=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(c){var d,e,f,g,h,i,j,k,l;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c.preventDefault();d=document.getElementById("comment");if(!(0===d.value.length)){a.next=7;break}d.classList.add("comment_error");return a.abrupt("return");case 7:d.classList.remove("comment_error");e=this.pdfData;f=Uint8Array.from(atob(e),function(a){return a.charCodeAt(0)});a.next=12;return b.PDFDocument.load(f);case 12:g=a.sent;h=g.getForm();i=h.getField("Text12");i.setText(d.value);a.next=18;return g.saveAsBase64();case 18:j=a.sent;k=this._getUser();l={id:k[0].id,userid:$("[data-action=\"change-user\"]")[0].getAttribute("data-selected"),courseid:$("[data-region=\"user-info\"]")[0].getAttribute("data-userid"),refexid:$("[data-region=\"user-info\"]")[0].getAttribute("data-rid"),pdf:j};this._updatePDFInDB(l);case 22:case"end":return a.stop();}}},a,this)}));return function(){return a.apply(this,arguments)}}();f.prototype._updatePDFInDB=function(a){var b=this,c=JSON.stringify(a);d.call([{methodname:"report_reflectionexporter_update_pdfbase64",args:{pdf:c},done:function done(a){console.log(a);var c=document.querySelector("[data-action='change-user']").getAttribute("data-selected"),d=parseInt(c,10),e=document.querySelector("[data-action='change-user']");document.getElementById("comment").value="";if(null!=e.options[e.selectedIndex].nextElementSibling){var f=e.options[e.selectedIndex].nextElementSibling.value;e.setAttribute("data-selected",f);e.value=f+"";if(!isNaN(d)&&0<d){$(document).trigger("user-changed",f)}}else{TODO:console.log("final");console.log(b);document.querySelector("div.next-action").classList.remove("next-action-hidden");document.getElementById("download").addEventListener("click",b._zipdownload)}},fail:function fail(a){console.log(a)}}])};f.prototype._zipdownload=function(){document.getElementById("zipform").submit()};return f});
//# sourceMappingURL=view_pdf.min.js.map
