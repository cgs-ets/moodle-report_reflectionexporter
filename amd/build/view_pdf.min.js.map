{"version":3,"sources":["../src/view_pdf.js"],"names":["define","PDFJSLIB","PDFLib","Templates","Ajax","url","ViewPDF","$","document","on","_init","bind","prototype","self","render","done","html","js","fadeOut","replaceNodeContents","fadeIn","user","_getUser","console","log","call","methodname","args","recorid","id","response","downloadurl","URL","window","location","href","pdfData","pdfbase64","searchParams","append","completed","status","context","courseurl","getElementById","getAttribute","downloadaction","datajson","querySelector","GlobalWorkerOptions","workerSrc","relativeUrl","loadingTask","getDocument","data","atob","currPage","numPages","thePDF","promise","then","pdf","getPage","handlePages","catch","error","reason","page","viewport","getViewport","scale","canvas","createElement","classList","add","height","width","getContext","canvasContext","appendChild","removeAttribute","addEventListener","_saveshownext","_savesandexit","remove","select","options","selectedIndex","nextElementSibling","_enableDownload","fail","userid","pdfjsons","JSON","parse","filter","_getUserId","e","preventDefault","_save","btnClicked","commentEl","value","length","stringPdfToBinary","Uint8Array","from","c","charCodeAt","PDFDocument","load","pdfDoc","form","getForm","commentsupervisor","getField","setText","flatten","saveAsBase64","toUpdate","courseid","refexid","exit","_updatePDFInDB","record","arg","stringify","replace","_updatejson","useridnumber","parseInt","nextuser","setAttribute","isNaN","trigger","_zipdownload","submit","json","i"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript to handle the PDF view\n *\n * @module     report_reflectionexporter/vew_pdf\n * @copyright  2022 Veronica Bermegui\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    \"report_reflectionexporter/pdf\",\n    \"report_reflectionexporter/pdf-lib\",\n    'core/templates',\n    'core/ajax',\n    'core/url'\n], function (PDFJSLIB, PDFLib, Templates, Ajax, url) {\n    \"use strict\";\n\n    var ViewPDF = function () {\n\n        $(document).on('user-changed', this._init.bind(this));\n\n\n    }\n\n    ViewPDF.prototype._init = function () {\n        var self = this;\n\n        Templates.render('report_reflectionexporter/loading', {}).done(function (html, js) {\n            // Update the page.\n            $('[data-region=\"pdf-comment-container\"]').fadeOut(\"fast\", function () {\n                Templates.replaceNodeContents($('[data-region=\"pdf-comment-container\"]'), html, js);\n                $('[data-region=\"pdf-comment-container\"]').fadeIn(\"fast\");\n\n            }.bind(this));\n\n            const user = self._getUser();\n\n            console.log(user);\n            // Call the service that returns the PDF.\n            Ajax.call([{\n                methodname: \"report_reflectionexporter_get_pdfbase64\",\n                args: {\n                    recorid: user[0].id, // This is the id of the record that  in mdl_report_reflec_exporter_pdf\n                },\n                done: function (response) {\n\n                    // Render the pdf container\n                    const downloadurl = new URL(window.location.href);\n                    self.pdfData = response.pdfbase64;\n                    downloadurl.searchParams.append('d', 1);\n                    self.completed = user[0].status == 'C' ? true : false;\n\n                    const context = {\n                        courseurl: document.getElementById(\"courseurl\").getAttribute('href'),\n                        downloadaction: downloadurl,\n                        datajson: document.querySelector('.data-pdfjson').getAttribute('data-pdfs'),\n                        completed: user[0].status == 'C' ? true : false\n                    }\n                    console.log(context);\n\n                    Templates.render('report_reflectionexporter/pdf_container', context).done(function (html, js) {\n\n                        Templates.replaceNodeContents($('[data-region=\"pdf-comment-container\"]'), html, js);\n\n                        const pdfData = self.pdfData;\n                        // The workerSrc property shall be specified.\n                        PDFJSLIB.GlobalWorkerOptions.workerSrc = url.relativeUrl('/report/reflectionexporter/amd/src/pdf.worker.js');\n                        var loadingTask = PDFJSLIB.getDocument({\n                            data: atob(pdfData)\n                        });\n                        var currPage = 1;\n                        var numPages = 0;\n                        var thePDF = null;\n\n                        loadingTask.promise.then(function (pdf) {\n\n                            //Set PDFJS global object (so we can easily access in our page functions\n                            thePDF = pdf;\n\n                            //How many pages it has\n                            numPages = pdf.numPages;\n\n                            // In chase the PDF was rendered before\n                            // deleteCanvas();\n\n                            //Start with first page\n                            pdf.getPage(1).then(handlePages).catch(error => console.log(error));\n                        }, function (reason) {\n                            console.error(reason);\n                        });\n\n                        async function handlePages(page) {\n                            //This gives us the page's dimensions at full scale\n                            var viewport = page.getViewport({\n                                scale: 1.5\n                            });\n                            //We'll create a canvas for each page to draw it on\n\n                            var canvas = document.createElement(\"canvas\");\n                            canvas.classList.add('pdf-page');\n                            canvas.height = viewport.height;\n                            canvas.width = viewport.width;\n                            var context = canvas.getContext('2d');\n\n                            // Draw it on the canvas\n                            await page.render({\n                                canvasContext: context,\n                                viewport: viewport\n                            });\n\n                            //Add it to the web page\n                            document.getElementById('viewer').appendChild(canvas);\n\n                            //Move to next page\n                            currPage++;\n\n                            if (thePDF !== null && currPage <= numPages) {\n                                thePDF.getPage(currPage).then(handlePages);\n                            }\n                        }\n\n                        // Display the form or status\n                        if (!self.completed) {\n                            document.querySelector('form.reflection-comment-form').removeAttribute('hidden');\n                            document.querySelector('button.save-show-next-btn').addEventListener('click', self._saveshownext.bind(self));\n                            document.querySelector('button.save-exit-btn').addEventListener('click', self._savesandexit.bind(self));\n                        } else {\n                            document.querySelector('h4.reflection-completed').classList.add('reflection-completed-display');\n                            document.querySelector('h4.reflection-completed').classList.remove('reflection-completed');\n\n                            // Check if its the last student, if so, display the download button.\n                            const select = document.querySelector(\"[data-action='change-user']\");\n\n                            if (select.options[select.selectedIndex].nextElementSibling == null) {\n                                self._enableDownload();\n                            }\n                        }\n                    });\n\n\n\n                },\n                fail: function (reason) {\n                    console.log(reason);\n                },\n            }, ]);\n        });\n    }\n\n\n    ViewPDF.prototype._getUser = function () {\n        const userid = $('[data-action=\"change-user\"]')[0].getAttribute('data-selected');\n        const pdfjsons = JSON.parse(document.querySelector('div.data-pdfjson').getAttribute('data-pdfs'));\n        const user = pdfjsons.filter(user => {\n            if (user.userid == userid) return user;\n        });\n        return user;\n    }\n\n    ViewPDF.prototype._getUserId = function () {\n        return $('[data-action=\"change-user\"]')[0].getAttribute('data-selected');\n    }\n\n    ViewPDF.prototype._saveshownext = function (e) {\n\n        e.preventDefault();\n        console.log(e);\n        this._save('shownext'); // TODO: Get the name of the button from the e object\n\n    }\n\n    // Save the data in BD\n    ViewPDF.prototype._save = async function (btnClicked) {\n\n        //Get the teacher comment from the textarea\n        const commentEl = document.getElementById('comment');\n        // Check it has content.\n        if (commentEl.value.length === 0) {\n            commentEl.classList.add('comment_error');\n            return;\n        } else {\n            commentEl.classList.remove('comment_error');\n\n            const pdfData = this.pdfData;\n            const stringPdfToBinary = Uint8Array.from(atob(pdfData), (c) => c.charCodeAt(0));\n\n            const pdfDoc = await PDFLib.PDFDocument.load(stringPdfToBinary);\n            const form = pdfDoc.getForm();\n            //Text12: Supervisor comments.\n            const commentsupervisor = form.getField('Text12');\n            commentsupervisor.setText(commentEl.value);\n\n            // Flatten the form's fields. This makes the pdf uneditable.\n            form.flatten();\n            // Save the PDF with the teacher comment. Cant edit anymore\n            const pdf = await pdfDoc.saveAsBase64();\n\n            const user = this._getUser();\n            const toUpdate = {\n                id: user[0].id,\n                userid: $('[data-action=\"change-user\"]')[0].getAttribute('data-selected'),\n                courseid: $('[data-region=\"user-info\"]')[0].getAttribute('data-userid'),\n                refexid: $('[data-region=\"user-info\"]')[0].getAttribute('data-rid'),\n                pdf: pdf,\n                exit: '0'\n            }\n            if (btnClicked != 'shownext') { // CLicked on exit\n                toUpdate.exit = '1';\n            }\n\n            // Update the pdf value in mdl_report_reflec_exporter_pdf\n            this._updatePDFInDB(toUpdate);\n\n        }\n    }\n    // Call WS to save pdf data in DB.\n    ViewPDF.prototype._updatePDFInDB = function (record) {\n\n        const self = this;\n        const arg = JSON.stringify(record);\n        const exit = record.exit;\n\n        Ajax.call([{\n            methodname: \"report_reflectionexporter_update_pdfbase64\",\n            args: {\n                pdf: arg,\n            },\n            done: function (response) {\n                console.log(response);\n\n                // if it comes from save and exit. redirect to the course.\n                if (exit == '1') {\n                    // This way we cant go back.\n                    window.location.replace(document.getElementById(\"courseurl\").getAttribute('href'));\n                    return;\n                }\n\n                // update the pdfjson with the status, so it cant be edited anymore\n                self._updatejson();\n\n                const userid = document.querySelector(\"[data-action='change-user']\").getAttribute('data-selected');\n                const useridnumber = parseInt(userid, 10);\n                const select = document.querySelector(\"[data-action='change-user']\");\n\n                document.getElementById('comment').value = ''; // Clear the textarea\n\n                if (select.options[select.selectedIndex].nextElementSibling != null) { // Check we didnt reach the end.\n\n                    const nextuser = select.options[select.selectedIndex].nextElementSibling.value;\n\n                    select.setAttribute('data-selected', nextuser);\n\n                    select.value = String(nextuser);\n                    // Trigger user change with the id of the next user\n                    if (!isNaN(useridnumber) && useridnumber > 0) {\n                        $(document).trigger('user-changed', nextuser);\n                    }\n\n                } else {\n                    $(document).trigger('user-changed', userid);\n                }\n\n\n\n            },\n            fail: function (reason) {\n                console.log(reason);\n            },\n        }, ]);\n    }\n\n    ViewPDF.prototype._zipdownload = function (e) {\n        document.getElementById('zipform').submit();\n    }\n\n\n    ViewPDF.prototype._savesandexit = function (e) {\n        e.preventDefault();\n        this._save('showexit');\n    }\n\n    ViewPDF.prototype._updatejson = function () {\n\n        const json = JSON.parse(document.querySelector('.data-pdfjson').getAttribute('data-pdfs'));\n        const userid = document.querySelector(\"[data-action='change-user']\").getAttribute('data-selected');\n        var i = 0;\n        for (i; i < json.length; i++) {\n            if (json[i].userid == userid) {\n                json[i].status = 'C';\n                break;\n            }\n        }\n\n        document.querySelector('.data-pdfjson').setAttribute('data-pdfs', JSON.stringify(json));\n    }\n\n    ViewPDF.prototype._enableDownload = function () {\n        const self = this;\n        document.querySelector('div.next-action').classList.remove('next-action-hidden');\n        document.getElementById('download').addEventListener('click', self._zipdownload);\n    }\n\n    return ViewPDF;\n\n});"],"file":"view_pdf.min.js"}