/**
 *
 *
 * @package    report
 * @subpackage reflectionexporter
 * @copyright  2022 Veronica Bermegui
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("report_reflectionexporter/reflectionexporter",["jquery","core/ajax","core/log","report_reflectionexporter/pdf-lib","core/templates"],(function($,Ajax,Log,PDFLib,Templates){function Controls(data){this.data=data,this.CANDIDATE_PERSONAL_CODE="Text1",this.FIRST_REFLECTION_SESSION="Text3",this.FIRST_REFLECTION_SESSION_SUPERVISOR_INITIALS="Text5",this.INTERIM_REFLECTION="Text6",this.INTERIM_REFLECTION_SUPERVISOR_INITIALS="Text8",this.FINAL_REFLECTION="Text9",this.FINAL_REFLECTION_SUPERVISOR_INITIALS="Text11",this.SUPERVISOR_COMMENT="Text12"}return Controls.prototype.main=function(){1==this.data.new?this.getreflectionsjson():this.getreflectionspdf()},Controls.prototype.getreflectionspdf=function(){this.displayTemplate()},Controls.prototype.getreflectionsjson=async function(){var self=this;Ajax.call([{methodname:"report_reflectionexporter_get_reflections",args:{rid:this.data.rid},done:async function(response){const users=JSON.parse(response.reflecjson),pdfs=await self.processReflections(users);self.savePDFInDB(pdfs)},fail:function(reason){Log.error(reason)}}])},Controls.prototype.processReflections=async function(users){const studentpdfs=[];for(var i=0;i<users.length;i++){const pdf=await this.fillformAndSave(users[i]),student={uid:users[i].reflections[0].userid,courseid:this.data.cid,rid:this.data.rid,pdf:pdf};studentpdfs.push(student)}return studentpdfs},Controls.prototype.fillformAndSave=async function(user){const formUrl=this.data.fileurl,formPdfBytes=await fetch(formUrl).then((res=>res.arrayBuffer())),pdfDoc=await PDFLib.PDFDocument.load(formPdfBytes),form=pdfDoc.getForm();return form.getFields().forEach((field=>{this.setFormFields(user,form,field)})),await pdfDoc.saveAsBase64()},Controls.prototype.setFormFields=async function(user,form,field){const fieldName=field.getName();switch(fieldName){case this.CANDIDATE_PERSONAL_CODE:Y.log(user),form.getTextField(fieldName).setText(String(user.id));break;case this.FIRST_REFLECTION_SESSION:form.getTextField(fieldName).setText(JSON.parse(user.reflections[0].onlinetext));break;case"Dropdown1":form.getDropdown(fieldName).select(user.reflections[0].month);break;case"Dropdown2":form.getDropdown(fieldName).select(String(user.dp));break;case this.FIRST_REFLECTION_SESSION_SUPERVISOR_INITIALS:form.getTextField(fieldName).setText(String(user.si));break;case this.INTERIM_REFLECTION:form.getTextField(fieldName).setText(JSON.parse(user.reflections[1].onlinetext));break;case"Dropdown3":form.getDropdown(fieldName).select(user.reflections[1].month);break;case"Dropdown4":form.getDropdown(fieldName).select(String(user.dp));break;case this.INTERIM_REFLECTION_SUPERVISOR_INITIALS:form.getTextField(fieldName).setText(String(user.si));break;case this.FINAL_REFLECTION:form.getTextField(fieldName).setText(JSON.parse(user.reflections[2].onlinetext));break;case"Dropdown5":form.getDropdown(fieldName).select(user.reflections[2].month);break;case"Dropdown6":form.getDropdown(fieldName).select(String(user.dp));break;case this.FINAL_REFLECTION_SUPERVISOR_INITIALS:form.getTextField(fieldName).setText(String(user.si))}},Controls.prototype.savePDFInDB=function(pdfs){var self=this;const pdfjson=JSON.stringify(pdfs);Ajax.call([{methodname:"report_reflectionexporter_save_pdfbase64",args:{pdfs:pdfjson},done:function(response){const context={pdfjson:response.savedrecords,courseid:self.data.cid,coursename:self.data.coursename,showuseridentity:!0,reflecid:self.data.rid,firstuserid:0};Templates.render("report_reflectionexporter/viewer",context).done((function(html,js){$(document.querySelector(".importing-animation")).fadeOut("fast",function(){Templates.replaceNodeContents($(document.querySelector(".importing-animation")),html,js),$(document.querySelector(".importing-animation")).fadeIn("fast")}.bind(this))})).fail((function(ex){console.log(ex)}))},fail:function(reason){Log.error(reason)}}])},Controls.prototype.displayTemplate=function(){const context={pdfjson:this.data.pdfjson,courseid:this.data.cid,coursename:this.data.coursename,showuseridentity:!0,reflecid:this.data.rid,firstuserid:0};Templates.render("report_reflectionexporter/viewer",context).done((function(html,js){$(document.querySelector(".importing-animation")).fadeOut("fast",function(){Templates.replaceNodeContents($(document.querySelector(".importing-animation")),html,js),$(document.querySelector(".importing-animation")).fadeIn("fast")}.bind(this))})).fail((function(ex){console.log(ex)}))},{init:function(data){new Controls(data).main()}}}));

//# sourceMappingURL=reflectionexporter.min.js.map