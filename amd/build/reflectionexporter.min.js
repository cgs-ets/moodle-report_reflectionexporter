function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}
/**
 *
 *
 * @package    report
 * @subpackage reflectionexporter
 * @copyright  2022 Veronica Bermegui
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */define("report_reflectionexporter/reflectionexporter",["jquery","core/ajax","core/log","report_reflectionexporter/pdf-lib","core/templates"],(function($,Ajax,Log,PDFLib,Templates){function Controls(data){this.data=data,this.CANDIDATE_PERSONAL_CODE="Text1",this.FIRST_REFLECTION_SESSION="Text3",this.FIRST_REFLECTION_SESSION_SUPERVISOR_INITIALS="Text5",this.INTERIM_REFLECTION="Text6",this.INTERIM_REFLECTION_SUPERVISOR_INITIALS="Text8",this.FINAL_REFLECTION="Text9",this.FINAL_REFLECTION_SUPERVISOR_INITIALS="Text11",this.SUPERVISOR_COMMENT="Text12"}var _ref2,_ref3,_ref4;return Controls.prototype.main=function(){1==this.data.new?this.getreflectionsjson():this.getreflectionspdf()},Controls.prototype.getreflectionspdf=function(){this.displayTemplate()},Controls.prototype.getreflectionsjson=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(){var self;return regeneratorRuntime.wrap((function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:self=this,Ajax.call([{methodname:"report_reflectionexporter_get_reflections",args:{rid:this.data.rid},done:function(){var _done=_asyncToGenerator(regeneratorRuntime.mark((function _callee(response){var users,pdfs;return regeneratorRuntime.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return users=JSON.parse(response.reflecjson),_context.next=3,self.processReflections(users);case 3:pdfs=_context.sent,self.savePDFInDB(pdfs);case 5:case"end":return _context.stop()}}),_callee)})));return function(_x){return _done.apply(this,arguments)}}(),fail:function(reason){Log.error(reason)}}]);case 2:case"end":return _context2.stop()}}),_callee2,this)}))),Controls.prototype.processReflections=(_ref2=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(users){var studentpdfs,i,pdf,student;return regeneratorRuntime.wrap((function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:studentpdfs=[],i=0;case 2:if(!(i<users.length)){_context3.next=11;break}return _context3.next=5,this.fillformAndSave(users[i]);case 5:pdf=_context3.sent,student={uid:users[i].reflections[0].userid,courseid:this.data.cid,rid:this.data.rid,pdf:pdf},studentpdfs.push(student);case 8:i++,_context3.next=2;break;case 11:return _context3.abrupt("return",studentpdfs);case 12:case"end":return _context3.stop()}}),_callee3,this)}))),function(_x2){return _ref2.apply(this,arguments)}),Controls.prototype.fillformAndSave=(_ref3=_asyncToGenerator(regeneratorRuntime.mark((function _callee4(user){var formUrl,formPdfBytes,pdfDoc,form,_this=this;return regeneratorRuntime.wrap((function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:return formUrl=this.data.fileurl,_context4.next=3,fetch(formUrl).then((function(res){return res.arrayBuffer()}));case 3:return formPdfBytes=_context4.sent,_context4.next=6,PDFLib.PDFDocument.load(formPdfBytes);case 6:return pdfDoc=_context4.sent,(form=pdfDoc.getForm()).getFields().forEach((function(field){_this.setFormFields(user,form,field)})),_context4.next=12,pdfDoc.saveAsBase64();case 12:return _context4.abrupt("return",_context4.sent);case 13:case"end":return _context4.stop()}}),_callee4,this)}))),function(_x3){return _ref3.apply(this,arguments)}),Controls.prototype.setFormFields=(_ref4=_asyncToGenerator(regeneratorRuntime.mark((function _callee5(user,form,field){var self,fieldName;return regeneratorRuntime.wrap((function(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:self=this,fieldName=field.getName(),_context5.t0=fieldName,_context5.next=_context5.t0===self.CANDIDATE_PERSONAL_CODE?5:_context5.t0===self.FIRST_REFLECTION_SESSION?8:"Dropdown1"===_context5.t0?10:"Dropdown2"===_context5.t0?12:_context5.t0===self.FIRST_REFLECTION_SESSION_SUPERVISOR_INITIALS?14:_context5.t0===self.INTERIM_REFLECTION?16:"Dropdown3"===_context5.t0?18:"Dropdown4"===_context5.t0?20:_context5.t0===self.INTERIM_REFLECTION_SUPERVISOR_INITIALS?22:_context5.t0===self.FINAL_REFLECTION?24:"Dropdown5"===_context5.t0?26:"Dropdown6"===_context5.t0?28:_context5.t0===self.FINAL_REFLECTION_SUPERVISOR_INITIALS?30:32;break;case 5:return Y.log(user),form.getTextField(fieldName).setText(String(user.id)),_context5.abrupt("break",32);case 8:return form.getTextField(fieldName).setText(JSON.parse(user.reflections[0].onlinetext)),_context5.abrupt("break",32);case 10:return form.getDropdown(fieldName).select(user.reflections[0].month),_context5.abrupt("break",32);case 12:case 20:case 28:return form.getDropdown(fieldName).select(String(user.dp)),_context5.abrupt("break",32);case 14:case 22:case 30:return form.getTextField(fieldName).setText(String(user.si)),_context5.abrupt("break",32);case 16:return form.getTextField(fieldName).setText(JSON.parse(user.reflections[1].onlinetext)),_context5.abrupt("break",32);case 18:return form.getDropdown(fieldName).select(user.reflections[1].month),_context5.abrupt("break",32);case 24:return form.getTextField(fieldName).setText(JSON.parse(user.reflections[2].onlinetext)),_context5.abrupt("break",32);case 26:return form.getDropdown(fieldName).select(user.reflections[2].month),_context5.abrupt("break",32);case 32:case"end":return _context5.stop()}}),_callee5,this)}))),function(_x4,_x5,_x6){return _ref4.apply(this,arguments)}),Controls.prototype.savePDFInDB=function(pdfs){var self=this,pdfjson=JSON.stringify(pdfs);Ajax.call([{methodname:"report_reflectionexporter_save_pdfbase64",args:{pdfs:pdfjson},done:function(response){var context={pdfjson:response.savedrecords,courseid:self.data.cid,coursename:self.data.coursename,showuseridentity:!0,reflecid:self.data.rid,firstuserid:0};Templates.render("report_reflectionexporter/viewer",context).done((function(html,js){$(document.querySelector(".importing-animation")).fadeOut("fast",function(){Templates.replaceNodeContents($(document.querySelector(".importing-animation")),html,js),$(document.querySelector(".importing-animation")).fadeIn("fast")}.bind(this))})).fail((function(ex){console.log(ex)}))},fail:function(reason){Log.error(reason)}}])},Controls.prototype.displayTemplate=function(){var context={pdfjson:this.data.pdfjson,courseid:this.data.cid,coursename:this.data.coursename,showuseridentity:!0,reflecid:this.data.rid,firstuserid:0};Templates.render("report_reflectionexporter/viewer",context).done((function(html,js){$(document.querySelector(".importing-animation")).fadeOut("fast",function(){Templates.replaceNodeContents($(document.querySelector(".importing-animation")),html,js),$(document.querySelector(".importing-animation")).fadeIn("fast")}.bind(this))})).fail((function(ex){console.log(ex)}))},{init:function(data){new Controls(data).main()}}}));

//# sourceMappingURL=reflectionexporter.min.js.map