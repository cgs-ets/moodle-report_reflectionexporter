{"version":3,"sources":["../src/viewing_navigation_user_info.js"],"names":["define","$","notification","ajax","templates","UserInfo","selector","_regionSelector","_region","_userCache","document","on","_refreshUserInfo","bind","prototype","_lastUserId","getRefExporterId","attr","event","userid","promise","Deferred","render","done","html","js","fadeOut","replaceNodeContents","fadeIn","fail","exception","resolve","rid","requests","call","methodname","args","refid","participant","hasOwnProperty","reject","context","courseid","user","identity","email","profileimageurl"],"mappings":"AAyBAA,OAAM,0DAAC,CAAC,QAAD,CAAW,mBAAX,CAAgC,WAAhC,CAA6C,gBAA7C,CAA+D,oCAA/D,CAAqG,wCAArG,CAAD,CAAiJ,SAAUC,CAAV,CAAaC,CAAb,CAA2BC,CAA3B,CAAiCC,CAAjC,CAAkE,CAQrN,GAAIC,CAAAA,CAAQ,CAAG,SAAUC,CAAV,CAAoB,CAC/B,KAAKC,eAAL,CAAuBD,CAAvB,CACA,KAAKE,OAAL,CAAeP,CAAC,CAACK,CAAD,CAAhB,CACA,KAAKG,UAAL,CAAkB,EAAlB,CAEAR,CAAC,CAACS,QAAD,CAAD,CAAYC,EAAZ,CAAe,cAAf,CAA+B,KAAKC,gBAAL,CAAsBC,IAAtB,CAA2B,IAA3B,CAA/B,CACH,CAND,CASAR,CAAQ,CAACS,SAAT,CAAmBP,eAAnB,CAAqC,IAArC,CAGAF,CAAQ,CAACS,SAAT,CAAmBL,UAAnB,CAAgC,IAAhC,CAGAJ,CAAQ,CAACS,SAAT,CAAmBN,OAAnB,CAA6B,IAA7B,CAGAH,CAAQ,CAACS,SAAT,CAAmBC,WAAnB,CAAiC,CAAjC,CASAV,CAAQ,CAACS,SAAT,CAAmBE,gBAAnB,CAAsC,UAAY,CAC9C,MAAO,MAAKR,OAAL,CAAaS,IAAb,CAAkB,UAAlB,CACV,CAFD,CAYAZ,CAAQ,CAACS,SAAT,CAAmBF,gBAAnB,CAAsC,SAAUM,CAAV,CAAiBC,CAAjB,CAAyB,CAC3D,GAAIC,CAAAA,CAAO,CAAGnB,CAAC,CAACoB,QAAF,EAAd,CAGA,KAAKb,OAAL,CAAaS,IAAb,CAAkB,aAAlB,CAAiCE,CAAjC,EAGA,GAAI,KAAKJ,WAAL,EAAoBI,CAAxB,CAAgC,CAC5B,MACH,CACD,KAAKJ,WAAL,CAAmBI,CAAnB,CAGAf,CAAS,CAACkB,MAAV,CAAiB,mCAAjB,CAAsD,EAAtD,EAA0DC,IAA1D,CAA+D,SAAUC,CAAV,CAAgBC,CAAhB,CAAoB,CAE/E,KAAKjB,OAAL,CAAakB,OAAb,CAAqB,MAArB,CAA6B,UAAY,CACrCtB,CAAS,CAACuB,mBAAV,CAA8B,KAAKnB,OAAnC,CAA4CgB,CAA5C,CAAkDC,CAAlD,EACA,KAAKjB,OAAL,CAAaoB,MAAb,CAAoB,MAApB,CACH,CAH4B,CAG3Bf,IAH2B,CAGtB,IAHsB,CAA7B,EAKA,GAAa,CAAT,CAAAM,CAAJ,CAAgB,CAEZf,CAAS,CAACkB,MAAV,CAAiB,uDAAjB,CAA0E,EAA1E,EAA8EC,IAA9E,CAAmF,SAAUC,CAAV,CAAgBC,CAAhB,CAAoB,CACnG,GAAIN,CAAM,EAAI,KAAKJ,WAAnB,CAAgC,CAE5B,KAAKP,OAAL,CAAakB,OAAb,CAAqB,MAArB,CAA6B,UAAY,CACrCtB,CAAS,CAACuB,mBAAV,CAA8B,KAAKnB,OAAnC,CAA4CgB,CAA5C,CAAkDC,CAAlD,EACA,KAAKjB,OAAL,CAAaoB,MAAb,CAAoB,MAApB,CACH,CAH4B,CAG3Bf,IAH2B,CAGtB,IAHsB,CAA7B,CAIH,CACJ,CARkF,CAQjFA,IARiF,CAQ5E,IAR4E,CAAnF,EAQcgB,IARd,CAQmB3B,CAAY,CAAC4B,SARhC,EASA,MACH,CAED,GAAuC,WAAnC,QAAO,MAAKrB,UAAL,CAAgBU,CAAhB,CAAX,CAAoD,CAChDC,CAAO,CAACW,OAAR,CAAgB,KAAKtB,UAAL,CAAgBU,CAAhB,CAAhB,CACH,CAFD,IAEO,IAECa,CAAAA,CAAG,CAAG,KAAKhB,gBAAL,EAFP,CAGCiB,CAAQ,CAAG9B,CAAI,CAAC+B,IAAL,CAAU,CAAC,CACtBC,UAAU,CAAE,2CADU,CAEtBC,IAAI,CAAE,CACFjB,MAAM,CAAEA,CADN,CAEFkB,KAAK,CAAEL,CAFL,CAFgB,CAAD,CAAV,CAHZ,CAWHC,CAAQ,CAAC,CAAD,CAAR,CAAYV,IAAZ,CAAiB,SAAUe,CAAV,CAAuB,CACpC,GAAI,CAACA,CAAW,CAACC,cAAZ,CAA2B,IAA3B,CAAL,CAAuC,CACnCnB,CAAO,CAACoB,MAAR,CAAe,UAAf,CACH,CAFD,IAEO,CACH,KAAK/B,UAAL,CAAgBU,CAAhB,EAA0BmB,CAA1B,CACAlB,CAAO,CAACW,OAAR,CAAgB,KAAKtB,UAAL,CAAgBU,CAAhB,CAAhB,CACH,CACJ,CAPgB,CAOfN,IAPe,CAOV,IAPU,CAAjB,EAOcgB,IAPd,CAOmB3B,CAAY,CAAC4B,SAPhC,CAQH,CAEDV,CAAO,CAACG,IAAR,CAAa,SAAUkB,CAAV,CAAmB,CAG5BA,CAAO,CAACC,QAAR,CAAmBzC,CAAC,CAAC,2CAAD,CAAD,CAA6CgB,IAA7C,CAAkD,eAAlD,CAAnB,CAEA,GAAIwB,CAAO,CAACE,IAAZ,CAAkB,CACdF,CAAO,CAACG,QAAR,CAAmBH,CAAO,CAACE,IAAR,CAAaE,KAAhC,CAEA,GAAIJ,CAAO,CAACE,IAAR,CAAaG,eAAjB,CAAkC,CAC9BL,CAAO,CAACK,eAAR,CAA0BL,CAAO,CAACE,IAAR,CAAaG,eAC1C,CACJ,CAED1C,CAAS,CAACkB,MAAV,CAAiB,2DAAjB,CAA8EmB,CAA9E,EAAuFlB,IAAvF,CAA4F,SAAUC,CAAV,CAAgBC,CAAhB,CAAoB,CAE5G,GAAIN,CAAM,EAAI,KAAKJ,WAAnB,CAAgC,CAC5B,KAAKP,OAAL,CAAakB,OAAb,CAAqB,MAArB,CAA6B,UAAY,CACrCtB,CAAS,CAACuB,mBAAV,CAA8B,KAAKnB,OAAnC,CAA4CgB,CAA5C,CAAkDC,CAAlD,EACA,KAAKjB,OAAL,CAAaoB,MAAb,CAAoB,MAApB,CACH,CAH4B,CAG3Bf,IAH2B,CAGtB,IAHsB,CAA7B,CAOH,CACJ,CAX2F,CAW1FA,IAX0F,CAWrF,IAXqF,CAA5F,EAWcgB,IAXd,CAWmB3B,CAAY,CAAC4B,SAXhC,CAcH,CA3BY,CA2BXjB,IA3BW,CA2BN,IA3BM,CAAb,EA2BcgB,IA3Bd,CA2BmB,UAAY,CAEvBzB,CAAS,CAACkB,MAAV,CAAiB,uDAAjB,CAA0E,EAA1E,EAA8EC,IAA9E,CAAmF,SAAUC,CAAV,CAAgBC,CAAhB,CAAoB,CAEnG,KAAKjB,OAAL,CAAakB,OAAb,CAAqB,MAArB,CAA6B,UAAY,CACrCtB,CAAS,CAACuB,mBAAV,CAA8B,KAAKnB,OAAnC,CAA4CgB,CAA5C,CAAkDC,CAAlD,EACA,KAAKjB,OAAL,CAAaoB,MAAb,CAAoB,MAApB,CACH,CAH4B,CAG3Bf,IAH2B,CAGtB,IAHsB,CAA7B,CAIH,CANkF,CAMjFA,IANiF,CAM5E,IAN4E,CAAnF,EAMcgB,IANd,CAMmB3B,CAAY,CAAC4B,SANhC,CAOH,CATc,CAUdjB,IAVc,CAUT,IAVS,CA3BnB,CAsCH,CAlF8D,CAkF7DA,IAlF6D,CAkFxD,IAlFwD,CAA/D,EAkFcgB,IAlFd,CAkFmB3B,CAAY,CAAC4B,SAlFhC,CAqFH,CAlGD,CAoGA,MAAOzB,CAAAA,CACV,CApJK,CAAN","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript controller for the \"User summary\" panel at the top of the page.\n *\n * @module     report_reflectionexporter/viewing_navigation_user_info\n * @package    report_reflectionexporte\n * @class      UserInfo\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\n * @copyright  2022 Veronica Bermegui\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later \n */\ndefine(['jquery', 'core/notification', 'core/ajax', 'core/templates', 'report_reflectionexporter/view_pdf', 'report_reflectionexporter/viewer_panel'], function ($, notification, ajax, templates, viewPDF, ViewerPanel) {\n\n    /**\n     * UserInfo class.\n     *\n     * @class UserInfo\n     * @param {String} selector The selector for the page region containing the user navigation.\n     */\n    var UserInfo = function (selector) {\n        this._regionSelector = selector;\n        this._region = $(selector);\n        this._userCache = {};\n\n        $(document).on('user-changed', this._refreshUserInfo.bind(this));\n    };\n\n    /** @type {String} Selector for the page region containing the user navigation. */\n    UserInfo.prototype._regionSelector = null;\n\n    /** @type {Array} Cache of user info contexts. */\n    UserInfo.prototype._userCache = null;\n\n    /** @type {JQuery} JQuery node for the page region containing the user navigation. */\n    UserInfo.prototype._region = null;\n\n    /** @type {Integer} Remember the last user id to prevent unnecessary reloads. */\n    UserInfo.prototype._lastUserId = 0;\n\n    /**\n     * Get the assignment id\n     *\n     * @private\n     * @method getRefExporterId\n     * @return {Integer} assignment id\n     */\n    UserInfo.prototype.getRefExporterId = function () {\n        return this._region.attr('data-rid');\n    };\n\n    /**\n     * Get the user context - re-render the template in the page.\n     *\n     * @private\n     * @method _refreshUserInfo\n     * @param {Event} event\n     * @param {Number} userid\n     */\n    UserInfo.prototype._refreshUserInfo = function (event, userid) {\n        var promise = $.Deferred();\n\n        // Put the current user ID in the DOM so yui can access it.\n        this._region.attr('data-userid', userid);\n\n        // Skip reloading if it is the same user.\n        if (this._lastUserId == userid) {\n            return;\n        }\n        this._lastUserId = userid;\n\n        // First insert the loading template.\n        templates.render('report_reflectionexporter/loading', {}).done(function (html, js) {\n            // Update the page.\n            this._region.fadeOut(\"fast\", function () {\n                templates.replaceNodeContents(this._region, html, js);\n                this._region.fadeIn(\"fast\");\n            }.bind(this));\n\n            if (userid < 0) {\n                // Render the template.\n                templates.render('report_reflectionexporter/viewing_navigation_no_users', {}).done(function (html, js) {\n                    if (userid == this._lastUserId) {\n                        // Update the page.\n                        this._region.fadeOut(\"fast\", function () {\n                            templates.replaceNodeContents(this._region, html, js);\n                            this._region.fadeIn(\"fast\");\n                        }.bind(this));\n                    }\n                }.bind(this)).fail(notification.exception);\n                return;\n            }\n\n            if (typeof this._userCache[userid] !== \"undefined\") {\n                promise.resolve(this._userCache[userid]);\n            } else {\n                // Load context from ajax.\n                var rid = this.getRefExporterId();\n                var requests = ajax.call([{\n                    methodname: 'report_reflectionexporter_get_participant',\n                    args: {\n                        userid: userid,\n                        refid: rid\n                    }\n                }]);\n\n                requests[0].done(function (participant) {\n                    if (!participant.hasOwnProperty('id')) {\n                        promise.reject('No users');\n                    } else {\n                        this._userCache[userid] = participant;\n                        promise.resolve(this._userCache[userid]);\n                    }\n                }.bind(this)).fail(notification.exception);\n            }\n\n            promise.done(function (context) {\n\n                // Render the template.\n                context.courseid = $('[data-region=\"viewer-navigation-panel\"]').attr('data-courseid');\n\n                if (context.user) {\n                    context.identity = context.user.email;;\n                    // Add profile image url to context.\n                    if (context.user.profileimageurl) {\n                        context.profileimageurl = context.user.profileimageurl;\n                    }\n                }\n\n                templates.render('report_reflectionexporter/viewing_navigation_user_summary', context).done(function (html, js) {\n                    // Update the page.\n                    if (userid == this._lastUserId) {\n                        this._region.fadeOut(\"fast\", function () {\n                            templates.replaceNodeContents(this._region, html, js);\n                            this._region.fadeIn(\"fast\");\n                        }.bind(this));\n\n                       \n\n                    }\n                }.bind(this)).fail(notification.exception);\n\n\n            }.bind(this)).fail(function () {\n                    // Render the template.\n                    templates.render('report_reflectionexporter/viewing_navigation_no_users', {}).done(function (html, js) {\n                        // Update the page.\n                        this._region.fadeOut(\"fast\", function () {\n                            templates.replaceNodeContents(this._region, html, js);\n                            this._region.fadeIn(\"fast\");\n                        }.bind(this));\n                    }.bind(this)).fail(notification.exception);\n                }\n                .bind(this));\n        }.bind(this)).fail(notification.exception);\n\n\n    };\n\n    return UserInfo;\n});"],"file":"viewing_navigation_user_info.min.js"}