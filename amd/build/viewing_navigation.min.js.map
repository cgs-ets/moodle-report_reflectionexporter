{"version":3,"sources":["../src/viewing_navigation.js"],"names":["define","$","notification","str","ajax","viewingNavigation","selector","_regionSelector","_region","_filters","_users","_firstLoadUsers","_loadAllUsers","find","on","_handlePreviousUser","bind","_handleNextUser","_handleChangeUser","document","_refreshSelector","_isLoading","prototype","_lastFilters","select","reflecid","attr","call","methodname","args","rid","done","_usersLoaded","fail","exception","users","i","option","length","createElement","value","id","text","fullname","add","firstUser","_selectUserById","userid","useridnumber","parseInt","isNaN","trigger","e","preventDefault","currentUserId","currentIndex","count","newIndex","event","options","querySelector","children","getAttribute","setAttribute","removeAttribute","Y","log","val"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript to handle changing users via the user selector in the header.\n *\n * @module     report_reflectionexporter/grading_navigation\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\n * @copyright  2022 Veronica Bermegui\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/notification', 'core/str', 'core/ajax'],\n    function ($, notification, str, ajax) {\n\n        /**\n         * viewingNavigation class.\n         *\n         * @class report_reflectionexporter/viewing_navigation\n         * @param {String} selector The selector for the page region containing the user navigation.\n         */\n        var viewingNavigation = function (selector) {\n            this._regionSelector = selector;\n            this._region = $(selector);\n            this._filters = [];\n            this._users = [];\n            this._firstLoadUsers = true;\n\n            // Get the current user list from a webservice.\n            this._loadAllUsers();\n\n            // We do not allow navigation while ajax requests are pending.\n            // Attach listeners to the select and arrow buttons.\n\n            this._region.find('[data-action=\"previous-user\"]').on('click', this._handlePreviousUser.bind(this));\n            this._region.find('[data-action=\"next-user\"]').on('click', this._handleNextUser.bind(this));\n            this._region.find('[data-action=\"change-user\"]').on('change', this._handleChangeUser.bind(this));\n\n            $(document).on('user-changed', this._refreshSelector.bind(this));\n\n            // var userid = $('[data-region=\"viewer-navigation-panel\"]').data('first-userid');\n\n            // if (userid) {\n            //     this._selectUserById(userid);\n            // }\n\n            $(document).bind(\"start-loading-user\", function () {\n                this._isLoading = true;\n            }.bind(this));\n\n            $(document).bind(\"finish-loading-user\", function () {\n                this._isLoading = false;\n            }.bind(this));\n        };\n\n        /** @property {Boolean} Boolean tracking active ajax requests. */\n        viewingNavigation.prototype._isLoading = false;\n\n        /** @property {String} Selector for the page region containing the user navigation. */\n        viewingNavigation.prototype._regionSelector = null;\n\n        /** @property {Array} The list of active filter keys */\n        viewingNavigation.prototype._filters = null;\n\n        /** @property {Array} The list of users */\n        viewingNavigation.prototype._users = null;\n\n        /** @property {JQuery} JQuery node for the page region containing the user navigation. */\n        viewingNavigation.prototype._region = null;\n\n        /** @property {String} Last active filters */\n        viewingNavigation.prototype._lastFilters = '';\n\n        /**\n         * Load the list of all users for this assignment.\n         *\n         * @private\n         * @method _loadAllUsers\n         * @return {Boolean} True if the user list was fetched.\n         */\n        viewingNavigation.prototype._loadAllUsers = function () {\n            var select = this._region.find('[data-action=change-user]');\n            var reflecid = select.attr('data-rid');\n\n            ajax.call([{\n                methodname: 'report_reflectionexporter_list_participants',\n                args: {\n                    rid: reflecid,\n                },\n                done: this._usersLoaded.bind(this),\n                fail: notification.exception\n            }]);\n            return true;\n        };\n\n        /**\n         * Call back to rebuild the user selector.\n         *\n         * @private\n         * @method _usersLoaded\n         * @param {Array} users\n         */\n        viewingNavigation.prototype._usersLoaded = function (users) {\n            this._firstLoadUsers = false;\n            this._users = users;\n\n            var select = this._region.find('[data-action=change-user]')[0];\n\n            for (var i = 0; i < this._users.length; i++) {\n                var option = document.createElement('option');\n                option.value = this._users[i].id;\n                option.text = this._users[i].fullname;\n                select.add(option);\n            }\n            // Select the first user to display the summary\n            var firstUser = this._users[0].id;\n            $('[data-region=\"viewer-navigation-panel\"]').attr('data-first-userid', firstUser);\n            $('[data-region=\"viewer-navigation-panel\"]').attr('first-userid', firstUser);\n\n            this._selectUserById(firstUser);\n        };\n\n        /**\n         * Select the specified user by id.\n         *\n         * @private\n         * @method _selectUserById\n         * @param {Number} userid\n         */\n        viewingNavigation.prototype._selectUserById = function (userid) {\n            var select = this._region.find('[data-action=change-user]');\n            var useridnumber = parseInt(userid, 10);\n            select.attr('data-selected', userid);\n\n            if (!isNaN(useridnumber) && useridnumber > 0) {\n                $(document).trigger('user-changed', userid);\n            }\n        };\n\n        /**\n         * Change to the previous user in the viewing list.\n         *\n         * @private\n         * @method _handlePreviousUser\n         * @param {Event} e\n         */\n        viewingNavigation.prototype._handlePreviousUser = function (e) {\n            e.preventDefault();\n            var select = this._region.find('[data-action=change-user]');\n            var currentUserId = select.attr('data-selected');\n            var i = 0;\n            var currentIndex = 0;\n\n            for (i = 0; i < this._users.length; i++) {\n                if (this._users[i].id == currentUserId) {\n                    currentIndex = i;\n                    break;\n                }\n            }\n\n            var count = this._users.length;\n            var newIndex = (currentIndex - 1);\n            if (newIndex < 0) {\n                newIndex = count - 1;\n            }\n\n            if (count) {\n                this._selectUserById(this._users[newIndex].id, newIndex);\n            }\n\n        };\n\n\n        /**\n         * Change to the next user in the viewing list.\n         *\n         * @param {Event} e\n         * @param {Boolean} saved Has the form already been saved? Skips checking for changes if true.\n         */\n        viewingNavigation.prototype._handleNextUser = function (e, saved) {\n            e.preventDefault();\n            var select = this._region.find('[data-action=change-user]');\n            var currentUserId = select.attr('data-selected');\n            var i = 0;\n            var currentIndex = 0;\n\n            for (i = 0; i < this._users.length; i++) {\n                if (this._users[i].id == currentUserId) {\n                    currentIndex = i;\n                    break;\n                }\n            }\n            var count = this._users.length;\n            var newIndex = (currentIndex + 1) % count;\n            if (count) {\n                this._selectUserById(this._users[newIndex].id);\n            }\n\n        };\n\n\n        /**\n         * Respond to a user-changed event by updating the selector.\n         *\n         * @private\n         * @method _refreshSelector\n         * @param {Event} event\n         * @param {String} userid\n         */\n        viewingNavigation.prototype._refreshSelector = function (event, userid) {\n            var select = this._region.find('[data-action=change-user]');\n            userid = parseInt(userid, 10);\n\n            var select = this._region.find('[data-action=change-user]');\n            userid = parseInt(userid, 10);\n\n            if (!isNaN(userid) && userid > 0) {\n                select.attr('data-selected', userid);\n            }\n\n            var i = 0;\n            var options = document.querySelector('[data-action=change-user]').children;\n            for (i; i < options.length; i++) {\n                if (options[i].getAttribute('value') == String(userid)) {\n                    options[i].setAttribute('selected', true);\n                } else if (options[i].getAttribute('selected')) {\n                    options[i].removeAttribute('selected')\n                }\n            }\n\n        };\n\n\n        /**\n         * Change to a different user in the viewing list.\n         *\n         * @private\n         * @method _handleChangeUser\n         */\n        viewingNavigation.prototype._handleChangeUser = function () {\n            Y.log('_handleChangeUser...');\n            var select = this._region.find('[data-action=change-user]');\n            var userid = parseInt(select.val(), 10);\n\n            if (this._isLoading) {\n                return;\n            }\n\n            if (!isNaN(userid) && userid > 0) {\n                select.attr('data-selected', userid);\n                $(document).trigger('user-changed', userid);\n\n            }\n        };\n\n        return viewingNavigation;\n    });"],"file":"viewing_navigation.min.js"}