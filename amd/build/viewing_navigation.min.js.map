{"version":3,"file":"viewing_navigation.min.js","sources":["../src/viewing_navigation.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript to handle changing users via the user selector in the header.\n *\n * @module     report_reflectionexporter/grading_navigation\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\n * @copyright  2022 Veronica Bermegui\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/notification', 'core/str', 'core/ajax'],\n    function ($, notification, str, ajax) {\n\n        /**\n         * viewingNavigation class.\n         *\n         * @class report_reflectionexporter/viewing_navigation\n         * @param {String} selector The selector for the page region containing the user navigation.\n         */\n        var viewingNavigation = function (selector) {\n            this._regionSelector = selector;\n            this._region = $(selector);\n            this._filters = [];\n            this._users = [];\n            this._firstLoadUsers = true;\n\n            // Get the current user list from a webservice.\n            this._loadAllUsers();\n\n            // We do not allow navigation while ajax requests are pending.\n            // Attach listeners to the select and arrow buttons.\n\n            this._region.find('[data-action=\"previous-user\"]').on('click', this._handlePreviousUser.bind(this));\n            this._region.find('[data-action=\"next-user\"]').on('click', this._handleNextUser.bind(this));\n            this._region.find('[data-action=\"change-user\"]').on('change', this._handleChangeUser.bind(this));\n\n            $(document).on('user-changed', this._refreshSelector.bind(this));\n\n\n            $(document).bind(\"start-loading-user\", function () {\n                this._isLoading = true;\n            }.bind(this));\n\n            $(document).bind(\"finish-loading-user\", function () {\n                this._isLoading = false;\n            }.bind(this));\n        };\n\n        /** @property {Boolean} Boolean tracking active ajax requests. */\n        viewingNavigation.prototype._isLoading = false;\n\n        /** @property {String} Selector for the page region containing the user navigation. */\n        viewingNavigation.prototype._regionSelector = null;\n\n        /** @property {Array} The list of active filter keys */\n        viewingNavigation.prototype._filters = null;\n\n        /** @property {Array} The list of users */\n        viewingNavigation.prototype._users = null;\n\n        /** @property {JQuery} JQuery node for the page region containing the user navigation. */\n        viewingNavigation.prototype._region = null;\n\n        /** @property {String} Last active filters */\n        viewingNavigation.prototype._lastFilters = '';\n\n        /**\n         * Load the list of all users for this assignment.\n         *\n         * @private\n         * @method _loadAllUsers\n         * @return {Boolean} True if the user list was fetched.\n         */\n        viewingNavigation.prototype._loadAllUsers = function () {\n            var select = this._region.find('[data-action=change-user]');\n            var reflecid = select.attr('data-rid');\n\n            ajax.call([{\n                methodname: 'report_reflectionexporter_list_participants',\n                args: {\n                    rid: reflecid,\n                },\n                done: this._usersLoaded.bind(this),\n                fail: notification.exception\n            }]);\n            return true;\n        };\n\n        /**\n         * Call back to rebuild the user selector.\n         *\n         * @private\n         * @method _usersLoaded\n         * @param {Array} users\n         */\n        viewingNavigation.prototype._usersLoaded = function (users) {\n            this._firstLoadUsers = false;\n            this._users = users;\n\n            var select = this._region.find('[data-action=change-user]')[0];\n\n            for (var i = 0; i < this._users.length; i++) {\n                var option = document.createElement('option');\n                option.value = this._users[i].id;\n                option.text = this._users[i].fullname;\n                select.add(option);\n            }\n            // Select the first user to display the summary\n            var firstUser = this._users[0].id;\n            $('[data-region=\"viewer-navigation-panel\"]').attr('data-first-userid', firstUser);\n            $('[data-region=\"viewer-navigation-panel\"]').attr('first-userid', firstUser);\n\n            this._selectUserById(firstUser);\n        };\n\n        /**\n         * Select the specified user by id.\n         *\n         * @private\n         * @method _selectUserById\n         * @param {Number} userid\n         */\n        viewingNavigation.prototype._selectUserById = function (userid) {\n            var select = this._region.find('[data-action=change-user]');\n            var useridnumber = parseInt(userid, 10);\n            select.attr('data-selected', userid);\n\n            if (!isNaN(useridnumber) && useridnumber > 0) {\n                $(document).trigger('user-changed', userid);\n            }\n        };\n\n        /**\n         * Change to the previous user in the viewing list.\n         *\n         * @private\n         * @method _handlePreviousUser\n         * @param {Event} e\n         */\n        viewingNavigation.prototype._handlePreviousUser = function (e) {\n            e.preventDefault();\n            var select = this._region.find('[data-action=change-user]');\n            var currentUserId = select.attr('data-selected');\n            var i = 0;\n            var currentIndex = 0;\n\n            for (i = 0; i < this._users.length; i++) {\n                if (this._users[i].id == currentUserId) {\n                    currentIndex = i;\n                    break;\n                }\n            }\n\n            var count = this._users.length;\n            var newIndex = (currentIndex - 1);\n            if (newIndex < 0) {\n                newIndex = count - 1;\n            }\n\n            if (count) {\n                this._selectUserById(this._users[newIndex].id, newIndex);\n            }\n\n        };\n\n\n        /**\n         * Change to the next user in the viewing list.\n         *\n         * @param {Event} e\n         * @param {Boolean} saved Has the form already been saved? Skips checking for changes if true.\n         */\n        viewingNavigation.prototype._handleNextUser = function (e, saved) {\n            e.preventDefault();\n            var select = this._region.find('[data-action=change-user]');\n            var currentUserId = select.attr('data-selected');\n            var i = 0;\n            var currentIndex = 0;\n\n            for (i = 0; i < this._users.length; i++) {\n                if (this._users[i].id == currentUserId) {\n                    currentIndex = i;\n                    break;\n                }\n            }\n            var count = this._users.length;\n            var newIndex = (currentIndex + 1) % count;\n            if (count) {\n                this._selectUserById(this._users[newIndex].id);\n            }\n\n        };\n\n\n        /**\n         * Respond to a user-changed event by updating the selector.\n         *\n         * @private\n         * @method _refreshSelector\n         * @param {Event} event\n         * @param {String} userid\n         */\n        viewingNavigation.prototype._refreshSelector = function (event, userid) {\n            var select = this._region.find('[data-action=change-user]');\n            userid = parseInt(userid, 10);\n\n            var select = this._region.find('[data-action=change-user]');\n            userid = parseInt(userid, 10);\n\n            if (!isNaN(userid) && userid > 0) {\n                select.attr('data-selected', userid);\n            }\n\n            var i = 0;\n            var options = document.querySelector('[data-action=change-user]').children;\n            for (i; i < options.length; i++) {\n                if (options[i].getAttribute('value') == String(userid)) {\n                    options[i].setAttribute('selected', true);\n                } else if (options[i].getAttribute('selected')) {\n                    options[i].removeAttribute('selected')\n                }\n            }\n\n        };\n\n\n        /**\n         * Change to a different user in the viewing list.\n         *\n         * @private\n         * @method _handleChangeUser\n         */\n        viewingNavigation.prototype._handleChangeUser = function () {\n            Y.log('_handleChangeUser...');\n            var select = this._region.find('[data-action=change-user]');\n            var userid = parseInt(select.val(), 10);\n\n            if (this._isLoading) {\n                return;\n            }\n\n            if (!isNaN(userid) && userid > 0) {\n                select.attr('data-selected', userid);\n                $(document).trigger('user-changed', userid);\n\n            }\n        };\n\n        return viewingNavigation;\n    });"],"names":["define","$","notification","str","ajax","viewingNavigation","selector","_regionSelector","_region","_filters","_users","_firstLoadUsers","_loadAllUsers","find","on","this","_handlePreviousUser","bind","_handleNextUser","_handleChangeUser","document","_refreshSelector","_isLoading","prototype","_lastFilters","reflecid","attr","call","methodname","args","rid","done","_usersLoaded","fail","exception","users","select","i","length","option","createElement","value","id","text","fullname","add","firstUser","_selectUserById","userid","useridnumber","parseInt","isNaN","trigger","e","preventDefault","currentUserId","currentIndex","count","newIndex","saved","event","options","querySelector","children","getAttribute","String","setAttribute","removeAttribute","Y","log","val"],"mappings":"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"}