{"version":3,"file":"viewing_navigation.min.js","sources":["../src/viewing_navigation.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Javascript to handle changing users via the user selector in the header.\r\n *\r\n * @module     report_reflectionexporter/grading_navigation\r\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\r\n * @copyright  2022 Veronica Bermegui\r\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['jquery', 'core/notification', 'core/str', 'core/ajax'],\r\n    function ($, notification, str, ajax) {\r\n\r\n        /**\r\n         * viewingNavigation class.\r\n         *\r\n         * @class report_reflectionexporter/viewing_navigation\r\n         * @param {String} selector The selector for the page region containing the user navigation.\r\n         */\r\n        var viewingNavigation = function (selector) {\r\n            this._regionSelector = selector;\r\n            this._region = $(selector);\r\n            this._filters = [];\r\n            this._users = [];\r\n            this._firstLoadUsers = true;\r\n\r\n            // Get the current user list from a webservice.\r\n            this._loadAllUsers();\r\n\r\n            // We do not allow navigation while ajax requests are pending.\r\n            // Attach listeners to the select and arrow buttons.\r\n\r\n            this._region.find('[data-action=\"previous-user\"]').on('click', this._handlePreviousUser.bind(this));\r\n            this._region.find('[data-action=\"next-user\"]').on('click', this._handleNextUser.bind(this));\r\n            this._region.find('[data-action=\"change-user\"]').on('change', this._handleChangeUser.bind(this));\r\n\r\n            $(document).on('user-changed', this._refreshSelector.bind(this));\r\n\r\n\r\n            $(document).bind(\"start-loading-user\", function () {\r\n                this._isLoading = true;\r\n            }.bind(this));\r\n\r\n            $(document).bind(\"finish-loading-user\", function () {\r\n                this._isLoading = false;\r\n            }.bind(this));\r\n        };\r\n\r\n        /** @property {Boolean} Boolean tracking active ajax requests. */\r\n        viewingNavigation.prototype._isLoading = false;\r\n\r\n        /** @property {String} Selector for the page region containing the user navigation. */\r\n        viewingNavigation.prototype._regionSelector = null;\r\n\r\n        /** @property {Array} The list of active filter keys */\r\n        viewingNavigation.prototype._filters = null;\r\n\r\n        /** @property {Array} The list of users */\r\n        viewingNavigation.prototype._users = null;\r\n\r\n        /** @property {JQuery} JQuery node for the page region containing the user navigation. */\r\n        viewingNavigation.prototype._region = null;\r\n\r\n        /** @property {String} Last active filters */\r\n        viewingNavigation.prototype._lastFilters = '';\r\n\r\n        /**\r\n         * Load the list of all users for this assignment.\r\n         *\r\n         * @private\r\n         * @method _loadAllUsers\r\n         * @return {Boolean} True if the user list was fetched.\r\n         */\r\n        viewingNavigation.prototype._loadAllUsers = function () {\r\n            var select = this._region.find('[data-action=change-user]');\r\n            var reflecid = select.attr('data-rid');\r\n\r\n            ajax.call([{\r\n                methodname: 'report_reflectionexporter_list_participants',\r\n                args: {\r\n                    rid: reflecid,\r\n                },\r\n                done: this._usersLoaded.bind(this),\r\n                fail: notification.exception\r\n            }]);\r\n            return true;\r\n        };\r\n\r\n        /**\r\n         * Call back to rebuild the user selector.\r\n         *\r\n         * @private\r\n         * @method _usersLoaded\r\n         * @param {Array} users\r\n         */\r\n        viewingNavigation.prototype._usersLoaded = function (users) {\r\n            this._firstLoadUsers = false;\r\n            this._users = users;\r\n\r\n            var select = this._region.find('[data-action=change-user]')[0];\r\n\r\n            for (var i = 0; i < this._users.length; i++) {\r\n                var option = document.createElement('option');\r\n                option.value = this._users[i].id;\r\n                option.text = this._users[i].fullname;\r\n                select.add(option);\r\n            }\r\n            // Select the first user to display the summary\r\n            var firstUser = this._users[0].id;\r\n            $('[data-region=\"viewer-navigation-panel\"]').attr('data-first-userid', firstUser);\r\n            $('[data-region=\"viewer-navigation-panel\"]').attr('first-userid', firstUser);\r\n\r\n            this._selectUserById(firstUser);\r\n        };\r\n\r\n        /**\r\n         * Select the specified user by id.\r\n         *\r\n         * @private\r\n         * @method _selectUserById\r\n         * @param {Number} userid\r\n         */\r\n        viewingNavigation.prototype._selectUserById = function (userid) {\r\n            var select = this._region.find('[data-action=change-user]');\r\n            var useridnumber = parseInt(userid, 10);\r\n            select.attr('data-selected', userid);\r\n\r\n            if (!isNaN(useridnumber) && useridnumber > 0) {\r\n                $(document).trigger('user-changed', userid);\r\n            }\r\n        };\r\n\r\n        /**\r\n         * Change to the previous user in the viewing list.\r\n         *\r\n         * @private\r\n         * @method _handlePreviousUser\r\n         * @param {Event} e\r\n         */\r\n        viewingNavigation.prototype._handlePreviousUser = function (e) {\r\n            e.preventDefault();\r\n            var select = this._region.find('[data-action=change-user]');\r\n            var currentUserId = select.attr('data-selected');\r\n            var i = 0;\r\n            var currentIndex = 0;\r\n\r\n            for (i = 0; i < this._users.length; i++) {\r\n                if (this._users[i].id == currentUserId) {\r\n                    currentIndex = i;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            var count = this._users.length;\r\n            var newIndex = (currentIndex - 1);\r\n            if (newIndex < 0) {\r\n                newIndex = count - 1;\r\n            }\r\n\r\n            if (count) {\r\n                this._selectUserById(this._users[newIndex].id, newIndex);\r\n            }\r\n\r\n        };\r\n\r\n\r\n        /**\r\n         * Change to the next user in the viewing list.\r\n         *\r\n         * @param {Event} e\r\n         * @param {Boolean} saved Has the form already been saved? Skips checking for changes if true.\r\n         */\r\n        viewingNavigation.prototype._handleNextUser = function (e, saved) {\r\n            e.preventDefault();\r\n            var select = this._region.find('[data-action=change-user]');\r\n            var currentUserId = select.attr('data-selected');\r\n            var i = 0;\r\n            var currentIndex = 0;\r\n\r\n            for (i = 0; i < this._users.length; i++) {\r\n                if (this._users[i].id == currentUserId) {\r\n                    currentIndex = i;\r\n                    break;\r\n                }\r\n            }\r\n            var count = this._users.length;\r\n            var newIndex = (currentIndex + 1) % count;\r\n            if (count) {\r\n                this._selectUserById(this._users[newIndex].id);\r\n            }\r\n\r\n        };\r\n\r\n\r\n        /**\r\n         * Respond to a user-changed event by updating the selector.\r\n         *\r\n         * @private\r\n         * @method _refreshSelector\r\n         * @param {Event} event\r\n         * @param {String} userid\r\n         */\r\n        viewingNavigation.prototype._refreshSelector = function (event, userid) {\r\n            var select = this._region.find('[data-action=change-user]');\r\n            userid = parseInt(userid, 10);\r\n\r\n            var select = this._region.find('[data-action=change-user]');\r\n            userid = parseInt(userid, 10);\r\n\r\n            if (!isNaN(userid) && userid > 0) {\r\n                select.attr('data-selected', userid);\r\n            }\r\n\r\n            var i = 0;\r\n            var options = document.querySelector('[data-action=change-user]').children;\r\n            for (i; i < options.length; i++) {\r\n                if (options[i].getAttribute('value') == String(userid)) {\r\n                    options[i].setAttribute('selected', true);\r\n                } else if (options[i].getAttribute('selected')) {\r\n                    options[i].removeAttribute('selected')\r\n                }\r\n            }\r\n\r\n        };\r\n\r\n\r\n        /**\r\n         * Change to a different user in the viewing list.\r\n         *\r\n         * @private\r\n         * @method _handleChangeUser\r\n         */\r\n        viewingNavigation.prototype._handleChangeUser = function () {\r\n            Y.log('_handleChangeUser...');\r\n            var select = this._region.find('[data-action=change-user]');\r\n            var userid = parseInt(select.val(), 10);\r\n\r\n            if (this._isLoading) {\r\n                return;\r\n            }\r\n\r\n            if (!isNaN(userid) && userid > 0) {\r\n                select.attr('data-selected', userid);\r\n                $(document).trigger('user-changed', userid);\r\n\r\n            }\r\n        };\r\n\r\n        return viewingNavigation;\r\n    });"],"names":["define","$","notification","str","ajax","viewingNavigation","selector","_regionSelector","_region","_filters","_users","_firstLoadUsers","_loadAllUsers","find","on","this","_handlePreviousUser","bind","_handleNextUser","_handleChangeUser","document","_refreshSelector","_isLoading","prototype","_lastFilters","reflecid","attr","call","methodname","args","rid","done","_usersLoaded","fail","exception","users","select","i","length","option","createElement","value","id","text","fullname","add","firstUser","_selectUserById","userid","useridnumber","parseInt","isNaN","trigger","e","preventDefault","currentUserId","currentIndex","count","newIndex","saved","event","options","querySelector","children","getAttribute","String","setAttribute","removeAttribute","Y","log","val"],"mappings":"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"}