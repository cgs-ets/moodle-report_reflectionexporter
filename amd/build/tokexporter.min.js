/**
 * Gets the Theory of Knowledge (TOK) ib form in PDF format and imports the
 * interactions and teacher comments into it.
 *
 * @package    report
 * @subpackage reflectionexporter
 * @copyright  2023 Veronica Bermegui
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("report_reflectionexporter/tokexporter",["jquery","core/ajax","core/log","report_reflectionexporter/pdf-lib","core/templates","report_reflectionexporter/reflectionexporterHelper"],(function($,Ajax,Log,PDFLib,Templates,ReHelper){function Controls(data){this.data=data,this.tokFormInputs=ReHelper.get_tok_form_inputs()}return Controls.prototype.main=function(){1==this.data.new?this.getInteractionsjson():this.getInteractionspdf()},Controls.prototype.getInteractionspdf=function(){this.displayTemplate()},Controls.prototype.getInteractionsjson=async function(){var self=this;Ajax.call([{methodname:"report_reflectionexporter_get_reflections",args:{rid:this.data.rid},done:async function(response){const users=JSON.parse(response.reflecjson),pdfs=await self.processInteractions(users);self.savePDFInDB(pdfs)},fail:function(reason){Log.error(reason),ReHelper.get_error_template(self.data)}}])},Controls.prototype.processInteractions=async function(users){const studentpdfs=[];for(var i=0;i<users.length;i++){const pdf=await this.fillformAndSave(users[i]),student={uid:users[i].interactions[0].userid,courseid:this.data.cid,rid:this.data.rid,pdf:pdf,formname:this.data.ibform};studentpdfs.push(student)}return studentpdfs},Controls.prototype.fillformAndSave=async function(user){const formUrl=this.data.fileurl,formPdfBytes=await fetch(formUrl).then((res=>res.arrayBuffer())),pdfDoc=await PDFLib.PDFDocument.load(formPdfBytes),form=pdfDoc.getForm();return form.getFields().forEach((field=>{this.setFormFields(user,form,field)})),await pdfDoc.saveAsBase64()},Controls.prototype.setFormFields=async function(user,form,field){const fieldName=field.getName();switch(fieldName){case this.tokFormInputs.CANDIDATE_PERSONAL_CODE:form.getTextField(fieldName).setText(String(user.id));break;case this.tokFormInputs.SESSION:form.getTextField(fieldName).setText(String(user.session));break;case this.tokFormInputs.PRESCRIBED_TITLE:form.getTextField(fieldName).setText(String(user.prescribedtitle));break;case this.tokFormInputs.FIRST_INTERACTION_CANDIDATE_COMMENTS:user.interactions[0].onlinetext=JSON.parse(user.interactions[0].onlinetext).replace(/(\r\n|\n|\r)/gm,""),form.getTextField(fieldName).setText(user.interactions[0].onlinetext);break;case this.tokFormInputs.FIRST_INTERACTION_CANDIDATE_DATE:form.getTextField(fieldName).setText(user.interactions[0].month);break;case this.tokFormInputs.SECOND_INTERACTION_CANDIDATE_COMMENTS:user.interactions[1].onlinetext=JSON.parse(user.interactions[1].onlinetext).replace(/(\r\n|\n|\r)/gm,""),form.getTextField(fieldName).setText(user.interactions[1].onlinetext);break;case this.tokFormInputs.SECOND_INTERACTION_CANDIDATE_DATE:form.getTextField(fieldName).setText(user.interactions[1].month);break;case this.tokFormInputs.THIRD_INTERACTION_CANDIDATE_COMMENTS:user.interactions[2].onlinetext=JSON.parse(user.interactions[2].onlinetext).replace(/(\r\n|\n|\r)/gm,""),form.getTextField(fieldName).setText(user.interactions[2].onlinetext);break;case this.tokFormInputs.THIRD_INTERACTION_CANDIDATE_DATE:form.getTextField(fieldName).setText(user.interactions[2].month);break;case this.tokFormInputs.TEACHER_COMMENTS:form.getTextField(fieldName).setText(user.comments);break;case this.tokFormInputs.COMPLETED_CANDIDATE_NAME:form.getTextField(fieldName).setText(`${user.firstname} ${user.lastname}`);break;case this.tokFormInputs.COMPLETED_CANDIDATE_SESSION_NUMBER:form.getTextField(fieldName).setText(user.session);break;case this.tokFormInputs.COMPLETED_DECLARATION_DATE1:form.getTextField(fieldName).setText(user.month);break;case this.tokFormInputs.COMPLETED_DECLARATION_TEACHER_NAME:form.getTextField(fieldName).setText(user.teachersname);break;case this.tokFormInputs.COMPLETED_DECLARATION_DATE2:form.getTextField(fieldName).setText(user.month);break;case this.tokFormInputs.COMPLETED_DECLARATION_SCHOOL_NAME:form.getTextField(fieldName).setText(user.schoolname);break;case this.tokFormInputs.COMPLETED_DECLARATION_SCHOOL_NUMBER:form.getTextField(fieldName).setText(user.schoolnumber)}},Controls.prototype.savePDFInDB=function(pdfs){var self=this;const pdfjson=JSON.stringify(pdfs);Ajax.call([{methodname:"report_reflectionexporter_save_pdfbase64",args:{pdfs:pdfjson},done:function(response){new URL(window.location.href).searchParams.append("d",1);const context={pdfjson:response.savedrecords,courseid:self.data.cid,coursename:self.data.coursename,showuseridentity:!0,reflecid:self.data.rid,firstuserid:0};Templates.render("report_reflectionexporter/viewer",context).done((function(html,js){$(document.querySelector(".importing-animation")).fadeOut("fast",function(){Templates.replaceNodeContents($(document.querySelector(".importing-animation")),html,js),$(document.querySelector(".importing-animation")).fadeIn("fast")}.bind(this))})).fail((function(ex){console.log(ex)}))},fail:function(reason){Log.error(reason),ReHelper.get_error_template(self.data)}}])},Controls.prototype.displayTemplate=function(){const context={pdfjson:this.data.pdfjson,courseid:this.data.cid,coursename:this.data.coursename,showuseridentity:!0,reflecid:this.data.rid,firstuserid:0};Templates.render("report_reflectionexporter/viewer",context).done((function(html,js){$(document.querySelector(".importing-animation")).fadeOut("fast",function(){Templates.replaceNodeContents($(document.querySelector(".importing-animation")),html,js),$(document.querySelector(".importing-animation")).fadeIn("fast")}.bind(this))})).fail((function(ex){console.log(ex)}))},{init:function(data){new Controls(data).main()}}}));

//# sourceMappingURL=tokexporter.min.js.map